!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).HandwritingBoard={})}(this,(function(t){"use strict";class e{width;height;hash;stackObj={};get preStackObj(){return this.stackObj[this.hash]||(this.stackObj[this.hash]={undoStack:[],redoStack:[]}),this.stackObj[this.hash]}get undoStack(){return this.preStackObj.undoStack}get redoStack(){return this.preStackObj.redoStack}constructor(t,e,i=""){this.width=t,this.height=e,this.hash=i}updateHash(t){this.hash=t}restoreState=()=>{};saveState(t){this.undoStack.push([...t]),this.redoStack.length=0}undo(){if(this.undoStack.length>0){const t=this.undoStack.pop();this.redoStack.push(t);let e=this.undoStack[this.undoStack.length-1];if(!e){const t=new Uint8ClampedArray(4*this.width*this.height);e=[{worldOffsetX:0,worldOffsetY:0,imageData:new ImageData(t,this.width,this.height),fragments:[],colLen:0}]}this.doRestoreState(e)}}redo(){if(this.redoStack.length>0){const t=this.redoStack.pop();this.undoStack.push(t),this.doRestoreState(t)}}doRestoreState(t){this.restoreState([...t])}}var i,s,h,r;function a(t,e,i){const s=t*Math.PI/180,h=Math.cos(s),r=Math.sin(s);return function(t,s){const a=t-e,o=s-i;return[a*h-o*r+e,a*r+o*h+i]}}function o(t,e){return(t+e)*(Math.PI/180)}function n(t,e,i,s,h){const r=s*(Math.PI/180),a=h*(Math.PI/180);return[t+i*Math.cos(r+a),e+i*Math.sin(r+a)]}function l(t,e,i,s,h){const r=i*(Math.PI/180),a=s-t,o=h-e;return[Math.cos(r)*a-Math.sin(r)*o+t,Math.sin(r)*a+Math.cos(r)*o+e]}function c(t,e){return(t%e+e)%e}function d(t,e){const i=document.createElement("canvas");return i.width=t,i.height=e,Object.assign(i.style,{left:"0",top:"0",position:"absolute","pointer-events":"none",width:"100%",height:"100%"}),i}t.WriteModel=void 0,(i=t.WriteModel||(t.WriteModel={})).WRITE="write",i.DRAW="draw",t.BGPattern=void 0,(s=t.BGPattern||(t.BGPattern={})).GRID="grid",s.GRID_PAPER="gridPaper",s.QUADRILLE_PAPER="quadrillePaper",t.ScrollDirection=void 0,(h=t.ScrollDirection||(t.ScrollDirection={})).ALL="all",h.X="x",h.Y="y",t.ShapeType=void 0,(r=t.ShapeType||(t.ShapeType={})).RULER="ruler",r.COMPASS="compass",r.COMPASS360="compass360",r.RIGHT_ANGLE_TRIANGLE="rightAngleTriangle",r.EQUILATERAL_TRIANGLE="equilateralTriangle";class g{ctx;cm;mm;path;width=0;height=0;marginH=0;degreeNumber=20;toolShapeCenterX=500;toolShapeCenterY=300;angle=45;constructor(t,e,i){this.ctx=t,this.cm=e,this.mm=i,this.marginH=5*this.mm,this.width=this.cm*this.degreeNumber+2*this.marginH,this.height=2.5*this.cm}getOutlineCtx(t,e,i,s,h){const r=this.ctx.canvas,{width:a,height:o}=r,n=new OffscreenCanvas(a,o).getContext("2d"),l=this.generatorOuterBorder(t,e,i,s);return n.strokeStyle=h,n.lineWidth=s,n.stroke(l),n}generatorOuterBorder(t,e,i,s=0){const h=this.width,r=this.height,o=t-s/2-h/2,n=e-s/2-r/2,l=i,c=this.cm,d=a(l,t,e);let g="";g+=`M${d(o,n).join(",")}`,g+=`L${d(o+h+s,n).join(",")}`,g+=`L${d(o+h+s,n+r+s).join(",")}`;const p=1.5*c+this.marginH,u=o+h-p,f=n+r+s,w=o+p+s,S=2*c/3,m=S/4,P=f-m;g+=`L${d(u,f).join(",")}`;let v=u-S;for(;v>w;)g+=`C${[...d(v+S/3,P-m),...d(v+2*S/3,P+m),...d(v,f)].join(",")}`,v-=S;g+=`L${d(o,f).join(",")}`,g+="z";const y=new Path2D(g);return this.path=y,y}draw(t=!1,e=0,i=0){const s=this.angle,h=this.toolShapeCenterX,r=this.toolShapeCenterY,o=this.ctx,n=o.canvas,l=this.marginH,c=this.cm,d=this.mm,g=this.degreeNumber,p=this.width,u=this.height,f=a(s,h,r);o.clearRect(0,0,n.width,n.height),o.save(),o.beginPath(),o.fillStyle="rgba(0,0,0,.08)";const w=this.generatorOuterBorder(h,r,s);o.fill(w),o.restore(),o.save(),o.strokeStyle="black",o.font="3mm serif",o.textAlign="center",o.textBaseline="top",o.beginPath();const S=.5*c,m=h-p/2,P=r-u/2,v=P+S+d,y=.6*S,T=.8*S;for(let t=0;t<=g;t++){const e=m+l+t*c;if(o.moveTo(...f(e,P)),o.lineTo(...f(e,P+S)),o.save(),o.translate(...f(e,v)),o.rotate(s*Math.PI/180),o.fillText(String(t),0,0),o.restore(),t<g)for(let t=1;t<10;t++){const i=e+t*d;o.moveTo(...f(i,P)),5===t?o.lineTo(...f(i,P+T)):o.lineTo(...f(i,P+y))}}if(o.stroke(),o.restore(),t){const t=e,s=i;o.save(),o.beginPath(),o.lineWidth=1/window.devicePixelRatio/4,o.strokeStyle="rgba(0,0,0,.8)",o.fillStyle="rgba(255,255,255,0.5)";const h=this.cm/5*3,[r,a]=[t,s];o.arc(r,a,h,0,2*Math.PI),o.fill(),o.beginPath(),o.lineWidth=1/window.devicePixelRatio/2,o.moveTo(r+Math.cos(Math.PI)*h,a),o.lineTo(r+Math.cos(Math.PI)*h/3*2,a),o.stroke(),o.moveTo(r+Math.cos(0)*h,a),o.lineTo(r+Math.cos(0)*h/3*2,a),o.stroke(),o.fillStyle="rgba(0,0,0,1)",o.font="4mm serif",o.textAlign="center",o.textBaseline="middle";let n=(Math.floor(this.angle)%360+360)%360;n>=270?n=360-n:n>=180?n-=180:n>=90&&(n=180-n),o.fillText(String(n),t,s),o.beginPath(),o.lineWidth=1,o.strokeStyle="rgba(0,0,0,1)";const l=2,c=-Math.PI/5;o.arc(r+Math.cos(c)*(h-2*l),a+Math.sin(c)*(h-2*l),l,0,2*Math.PI),o.stroke(),o.restore()}}isPointInPath(t,e,i){return this.ctx.isPointInPath(this.path,t,e,i)}}let p=class{ctx;cm;mm;path;r;middleR;smallR;middleGap;startAngle=170;endAngle=370;innerStartAngle=180;innerEndAngle=360;toolShapeCenterX=500;toolShapeCenterY=300;angle=10;constructor(t,e,i){this.ctx=t,this.cm=e,this.mm=i,this.r=6*e,this.middleR=3.5*e,this.middleGap=1*e,this.smallR=2.2*e}getOutlineCtx(t,e,i,s,h){const r=this.ctx.canvas,{width:a,height:o}=r,n=new OffscreenCanvas(a,o).getContext("2d"),l=this.generatorOuterBorder(t,e,i,s);return n.strokeStyle=h,n.lineWidth=s,n.stroke(l),n}generatorOuterBorder(t,e,i,s=0){const h=this.startAngle,r=this.endAngle,a=this.innerStartAngle,l=this.innerEndAngle,c=this.r+s/2,d=this.middleR+s/2,g=d+this.middleGap-s,p=this.smallR-s/2,u=t,f=e,w=t,S=e,m=new Path2D;return m.arc(u,f,c,o(h,i),o(r,i)),m.closePath(),m.moveTo(...n(w,S,g,a,i)),m.arc(w,S,g,o(a,i),o(l,i)),m.lineTo(...n(w,S,d,l,i)),m.arc(w,S,d,o(l,i),o(a,i),!0),m.lineTo(...n(w,S,g,a,i)),m.moveTo(...n(w,S,p,a,i)),m.arc(w,S,p,o(a,i),o(l,i)),m.closePath(),this.path=m,m}drawDegree(t,e,i,s,h,r,a,o,n,l,c,d,g,p=!1){const u=this.ctx,f=Math.PI/180;let w=(180+g)*Math.PI/180;u.save(),u.textAlign="center",u.textBaseline="middle",u.font=`${a}px Arial`,d||(i+=r,u.textBaseline="bottom");for(let a=0;a<=180;a++){if(a%10==0){const s=t+Math.cos(w)*(i-r),h=e+Math.sin(w)*(i-r),l=t+Math.cos(w)*i,c=e+Math.sin(w)*i;if(u.beginPath(),u.moveTo(s,h),u.lineTo(l,c),u.stroke(),n&&a%10==0){const s=t+Math.cos(w)*(i-(r+o)*Number(d)),h=e+Math.sin(w)*(i-(r+o)*Number(d));u.save(),u.textAlign="center",u.translate(s,h),u.rotate(w+Math.PI/2),u.fillText((p?180-a:a).toString(),0,0),u.restore()}}else if(a%5){if(l){const h=t+Math.cos(w)*(i-s),r=e+Math.sin(w)*(i-s),a=t+Math.cos(w)*i,o=e+Math.sin(w)*i;u.beginPath(),u.moveTo(h,r),u.lineTo(a,o),u.stroke()}}else if(c){const s=t+Math.cos(w)*(i-h),r=e+Math.sin(w)*(i-h),a=t+Math.cos(w)*i,o=e+Math.sin(w)*i;u.beginPath(),u.moveTo(s,r),u.lineTo(a,o),u.stroke()}w+=f}u.restore()}drawContent(t,e,i){const s=this.r,h=this.middleR,r=this.smallR,a=t,o=e,n=this.ctx;n.save(),this.drawDegree(a,o,s,10,15,20,8,10,!0,!0,!0,!0,i),this.drawDegree(a,o,h,10,12,15,0,0,!1,!0,!0,!0,i),this.drawDegree(a,o,r,0,0,12,7,10,!0,!1,!1,!1,i,!0),n.restore()}drawPosition(t,e,i){const s=this.ctx;s.save(),s.beginPath(),s.moveTo(t,e),s.lineTo(...n(t,e,20,90,i)),s.stroke(),s.beginPath(),s.arc(t,e,20,o(0,i),o(180,i)),s.stroke(),s.restore()}draw(){const t=this.angle,e=this.toolShapeCenterX,i=this.toolShapeCenterY,s=this.ctx,h=s.canvas;s.clearRect(0,0,h.width,h.height),s.save(),s.beginPath(),s.fillStyle="rgba(0,0,0,.08)";const r=this.generatorOuterBorder(e,i,t);s.fill(r,"evenodd"),s.restore(),this.drawContent(e,i,t),this.drawPosition(e,i,t)}isPointInPath(t,e,i){return this.ctx.isPointInPath(this.path,t,e,i)}};class u{ctx;cm;mm;container;getPageCoords;toolShape;path;outsideR;insideR;pointerW;startAngle=0;endAngle=360;firstPointerAngle=0;secondPointerAngle=30;pointer1;pointer2;toolShapeCenterX=500;toolShapeCenterY=300;angle=10;constructor(t,e,i,s,h,r){this.ctx=t,this.cm=e,this.mm=i,this.container=s,this.getPageCoords=h,this.toolShape=r,this.outsideR=6*e,this.insideR=4.5*e,this.pointerW=1*e,this.loadEvent()}calculateRotationAngle(t,e,i,s){const h=this.toolShapeCenterX,r=this.toolShapeCenterY,a=t-h,o=e-r,n=i-h,l=s-r,c=(a*n+o*l)/(Math.sqrt(a*a+o*o)*Math.sqrt(n*n+l*l)),d=Math.acos(c);return 180*(a*l-o*n>=0?d:-d)/Math.PI}loadEvent(){const t=this.container;let e=0,i=0,s=0,h=0,r=!1,a=!1,o=!1;const n=(t,e)=>{const i=this.ctx,n=this.pointer1,l=this.pointer2;s=t.pageX,h=t.pageY,l&&i.isPointInPath(l,t.pageX,t.pageY)?(e.stopImmediatePropagation(),o=!0,r=!0):n&&i.isPointInPath(n,t.pageX,t.pageY)&&(e.stopImmediatePropagation(),a=!0,r=!0)},l=t=>{e=s,i=h,s=t.pageX,h=t.pageY;const r=this.calculateRotationAngle(e,i,s,h);isNaN(r)||(a?this.firstPointerAngle+=r:o&&(this.secondPointerAngle+=r)),this.draw(),this.toolShape.reset()};t.addEventListener("pointerdown",(t=>{t.preventDefault();const{pageX:e,pageY:i}=t,s=this.getPageCoords([{pageX:e,pageY:i}]);n(s,t)})),self.addEventListener("pointermove",(t=>{if(r){t.stopImmediatePropagation();const{pageX:e,pageY:i}=t,s=this.getPageCoords([{pageX:e,pageY:i}]);l(s)}}),{passive:!0}),self.addEventListener("pointerup",(t=>{r=!1,a=!1,o=!1}),{passive:!0})}getOutlineCtx(t,e,i,s,h){const r=this.ctx.canvas,{width:a,height:o}=r,n=new OffscreenCanvas(a,o).getContext("2d"),l=t,c=e,d=i;this.drawBorder(n,l,c,d,0,"rgba(0,0,0,1)"),this.drawPointer(n,l,c,d,this.firstPointerAngle,0,"rgba(0,0,0,1)"),this.drawPointer(n,l,c,d,this.secondPointerAngle,0,"rgba(0,0,0,1)"),n.globalCompositeOperation="source-out";const g=new OffscreenCanvas(a,o),p=g.getContext("2d");return this.drawBorder(p,l,c,d,s,"rgba(0,0,0,1)"),this.drawPointer(p,l,c,d,this.firstPointerAngle,s,"rgba(0,0,0,1)"),this.drawPointer(p,l,c,d,this.secondPointerAngle,s,"rgba(0,0,0,1)"),n.drawImage(g,0,0),n.globalCompositeOperation="source-in",n.fillStyle=h,n.fillRect(0,0,a,o),n}generatorOuterBorder(t,e,i){const s=this.startAngle,h=this.endAngle,r=(this.outsideR+this.insideR)/2,a=t,n=e,l=new Path2D;return l.arc(a,n,r,o(s,i),o(h,i)),this.path=l,l}generatorPointer(t,e,i,s,h){const r=this.outsideR,o=t,n=e,l=this.pointerW/2+h;let c=i;c+=s;const d=a(c,t,e);let g="";g+=`M${d(o,n-l).join(",")}`,g+=`A${l},${l},1,1,1,${d(o,n+l).join(",")}`,g+=`L${d(o-r,n+l).join(",")}`,g+=`A${l},${l},1,1,1,${d(o-r,n-l).join(",")}`,g+="z";return new Path2D(g)}drawDegree(t,e,i,s,h,r,a,o,n,l,c,d,g,p,u){const f=this.ctx,w=360,S=2*Math.PI/w;let m=(180+p)*Math.PI/180;f.save(),f.textAlign="center",f.textBaseline="middle",f.font=`${a}px Arial`,g||(i+=r,f.textBaseline="bottom");for(let a=0;a<=w;a++){if(a%10==0){const s=t+Math.cos(m)*(i-r),h=e+Math.sin(m)*(i-r),l=t+Math.cos(m)*i,c=e+Math.sin(m)*i;if(d&&(f.beginPath(),f.moveTo(s,h),f.lineTo(l,c),f.stroke()),a!==w&&n&&a%10==0){const s=t+Math.cos(m)*(i-(r+o)*Number(g)),h=e+Math.sin(m)*(i-(r+o)*Number(g));f.save(),f.textAlign="center",f.translate(s,h),f.rotate(m+Math.PI/2),f.fillText((u?w-a:a).toString(),0,0),f.restore()}}else if(a%5){if(l){const h=t+Math.cos(m)*(i-s),r=e+Math.sin(m)*(i-s),a=t+Math.cos(m)*i,o=e+Math.sin(m)*i;f.beginPath(),f.moveTo(h,r),f.lineTo(a,o),f.stroke()}}else if(c){const s=t+Math.cos(m)*(i-h),r=e+Math.sin(m)*(i-h),a=t+Math.cos(m)*i,o=e+Math.sin(m)*i;f.beginPath(),f.moveTo(s,r),f.lineTo(a,o),f.stroke()}m+=S}f.restore()}drawContent(t,e,i){const s=this.outsideR,h=t,r=e,a=this.ctx;a.save(),this.drawDegree(h,r,s,10,15,20,8,10,!0,!0,!0,!0,!0,i,!1),this.drawDegree(h,r,s,10,15,20,8,25,!0,!1,!1,!1,!0,i,!0),a.restore()}drawBorder(t,e,i,s,h,r){const a=this.outsideR,o=this.insideR;t.save(),t.beginPath(),t.lineWidth=a-o+2*h,t.strokeStyle=r;const n=this.generatorOuterBorder(e,i,s);t.stroke(n),t.restore()}drawPointer(t,e,i,s,h,r,a){t.save(),t.beginPath(),t.fillStyle=a;const o=this.generatorPointer(e,i,s,h,r);return t.fill(o),t.restore(),o}drawFixedPoint(t,e,i){const s=this.ctx;s.save(),s.beginPath(),s.fillStyle="rgba(0,0,0,.08)",s.arc(t,e,this.pointerW/4,0,2*Math.PI),s.fill(),s.restore()}draw(){const t=this.angle,e=this.toolShapeCenterX,i=this.toolShapeCenterY,s=this.ctx,h=s.canvas;s.clearRect(0,0,h.width,h.height),this.drawBorder(s,e,i,t,0,"rgba(0,0,0,.08)"),this.drawContent(e,i,t),this.pointer1=this.drawPointer(s,e,i,t,this.firstPointerAngle,0,"rgba(0,0,0,.08)"),this.pointer2=this.drawPointer(s,e,i,t,this.secondPointerAngle,0,"rgba(0,0,0,.08)"),this.drawFixedPoint(e,i,t)}isPointInPath(t,e,i){const s=this.ctx;if("evenodd"===i){let i=!1;return s.save(),s.lineWidth=this.outsideR-this.insideR,i=s.isPointInStroke(this.path,t,e),s.restore(),i}return s.isPointInPath(this.path,t,e)}}class f{ctx;cm;mm;degreeNumberH;degreeNumberV;marginH;marginV;path;width=0;height=0;marginC=0;gap=0;toolShapeCenterX=500;toolShapeCenterY=300;angle=0;constructor(t,e,i,s,h,r,a){this.ctx=t,this.cm=e,this.mm=i,this.degreeNumberH=s,this.degreeNumberV=h,this.marginH=r,this.marginV=a,this.marginC=this.cm,this.width=this.cm*this.degreeNumberH+this.marginH+this.marginC,this.height=this.cm*this.degreeNumberV+this.marginV+this.marginC,this.gap=1.5*this.cm}getOutlineCtx(t,e,i,s,h){const r=this.ctx.canvas,{width:a,height:o}=r,n=new OffscreenCanvas(a,o).getContext("2d"),l=this.generatorOuterBorder(t,e,i,s);return n.strokeStyle=h,n.lineWidth=s,n.stroke(l),n}generatorOuterBorder(t,e,i,s=0){const h=this.width,r=this.height,o=t-h/2-s/2,n=e-r/2-s/2,l=a(i,t,e),c=new Path2D;c.moveTo(...l(o+h+s+s*h/(h+r),n)),c.lineTo(...l(o,n)),c.lineTo(...l(o,n+r+s+s*r/(h+r))),c.closePath();const d=this.gap,g=o+d+s,p=n+d+s,u=h/2,f=r/2;return c.moveTo(...l(g+u-s-s*h/(h+r),p)),c.lineTo(...l(g,p)),c.lineTo(...l(g,p+f-s-s*h/(h+r))),c.closePath(),this.path=c,c}draw(){const t=this.angle,e=this.toolShapeCenterX,i=this.toolShapeCenterY,s=this.ctx,h=s.canvas,r=this.marginC,o=this.cm,n=this.mm,l=this.degreeNumberH,c=this.degreeNumberV,d=this.width,g=this.height,p=a(t,e,i);s.clearRect(0,0,h.width,h.height),s.save(),s.beginPath(),s.fillStyle="rgba(0,0,0,.08)";const u=this.generatorOuterBorder(e,i,t);s.fill(u,"evenodd"),s.restore(),s.save(),s.strokeStyle="black",s.font="3mm serif",s.textAlign="center",s.textBaseline="top",s.beginPath();const f=.5*o,w=e-d/2,S=i-g/2,m=.6*f,P=.8*f;for(let e=0;e<=l;e++){const i=w+r+e*o;if(s.moveTo(...p(i,S)),s.lineTo(...p(i,S+f)),s.save(),s.translate(...p(i,S+f+n)),s.rotate(t*Math.PI/180),s.fillText(String(e),0,0),s.restore(),e<l)for(let t=1;t<10;t++){const e=i+t*n;s.moveTo(...p(e,S)),5===t?s.lineTo(...p(e,S+P)):s.lineTo(...p(e,S+m))}}for(let e=0;e<=c;e++){const i=S+r+e*o;if(s.moveTo(...p(w,i)),s.lineTo(...p(w+f,i)),s.save(),s.translate(...p(w+f+n,i)),s.rotate(t*Math.PI/180-Math.PI/2),s.fillText(String(e),0,0),s.restore(),e<c)for(let t=1;t<10;t++){const e=i+t*n;s.moveTo(...p(w,e)),5===t?s.lineTo(...p(w+P,e)):s.lineTo(...p(w+m,e))}}s.stroke(),s.restore()}isPointInPath(t,e,i){return this.ctx.isPointInPath(this.path,t,e,i)}}class w{w;h;voice;canvas;ctx;getNearestDistanceAndPointVoice;outlineCtx;outlineImageData;outline;longestDistance=30;gatherAreaWidth=10;prevPoint=null;_toolShapeType=t.ShapeType.RULER;strokeStyle;cm=0;mm=0;width=0;height=0;marginH=0;degreeNumber=20;ruler;compass;compass360;rightAngleTriangle;equilateralTriangle;constructor(t,e,i,s,h){this.w=t,this.h=e,this.voice=i,this.canvas=d(t,e),this.ctx=this.canvas.getContext("2d"),this.cm=96/2.54,this.mm=this.cm/10,this.getNearestDistanceAndPointVoice=i,this.ruler=new g(this.ctx,this.cm,this.mm),this.compass=new p(this.ctx,this.cm,this.mm),this.compass360=new u(this.ctx,this.cm,this.mm,s,h,this),this.rightAngleTriangle=new f(this.ctx,this.cm,this.mm,9,5,3*this.cm,1*this.cm),this.equilateralTriangle=new f(this.ctx,this.cm,this.mm,6,6,2*this.cm,2*this.cm)}resize(t,e){this.width=t,this.height=e,this.canvas.width=this.width,this.canvas.height=this.height}set toolShapeCenterX(t){this.shape.toolShapeCenterX=t,this.reset()}get toolShapeCenterX(){return this.shape.toolShapeCenterX}set toolShapeCenterY(t){this.shape.toolShapeCenterY=t,this.reset()}get toolShapeCenterY(){return this.shape.toolShapeCenterY}set angle(t){this.shape.angle=t,this.reset()}get angle(){return this.shape.angle}set toolShapeType(t){this._toolShapeType=t,this.reset(),this.draw()}get toolShapeType(){return this._toolShapeType}get shape(){let e;switch(this.toolShapeType){case t.ShapeType.RULER:e=this.ruler;break;case t.ShapeType.COMPASS:e=this.compass;break;case t.ShapeType.COMPASS360:e=this.compass360;break;case t.ShapeType.RIGHT_ANGLE_TRIANGLE:e=this.rightAngleTriangle;break;case t.ShapeType.EQUILATERAL_TRIANGLE:e=this.equilateralTriangle;break;default:e=this.ruler}return e}reset(){this.outline=null,this.prevPoint=null}getGatherAreas(t,e,i,s,h){const r=this.outlineImageData.data,a=4*this.w,o=[],n=Math.min(t,i)-h/2,l=Math.min(e,s)-h/2,c=Math.max(t,i)+h/2,d=Math.max(e,s)+h/2,g=4*n,p=4*(c+1),u=d+1,f=p-g;let w=0;for(let t=l;t<u;t++){const e=t*a,i=e+g,s=e+p,h=r.subarray(i,s);o.push({start:f*w,end:f*(w+1),data:h}),w++}return{x:n,y:l,width:c-n+1,height:d-l+1,fragments:o}}getNearestDistanceAndPoint(t,e,i,s){this.outline&&i===this.getNearestDistanceAndPointVoice&&this.strokeStyle===s||(this.getNearestDistanceAndPointVoice=i,this.strokeStyle=s,this.outlineCtx=this.getOutlineCtx(this.getNearestDistanceAndPointVoice,s),this.outlineImageData=this.outlineCtx.getImageData(0,0,this.w,this.h),this.outline=this.getOutline(this.outlineImageData));const h=this.outline,r=h.length;let a=this.prevPoint;const o=Math.max(this.gatherAreaWidth,3*i);if(a){const i=[];for(let t=0;t<r;t++){const[e,s]=h[t];((a[0]-e)**2+(a[1]-s)**2)**.5<=o&&i.push(h[t])}let s=Number.MAX_SAFE_INTEGER,n=null;for(let h=0;h<i.length;h++){const[r,a]=i[h],o=((t-r)**2+(e-a)**2)**.5;o<s&&(s=o,n=[r,a])}let l={x:0,y:0,width:0,height:0,fragments:[]};return n&&(l=this.getGatherAreas(a[0],a[1],n[0],n[1],o)),this.prevPoint=n,{conformingToDistance:!0,gatherAreasObj:l}}{let i=Number.MAX_SAFE_INTEGER;for(let s=0;s<r;s++){const[r,o]=h[s],n=((t-r)**2+(e-o)**2)**.5;n<i&&(i=n,a=[r,o])}return this.prevPoint=a,{conformingToDistance:i<=this.longestDistance,drawPoints:[]}}}getOutlineCtx(t,e){return this.shape.getOutlineCtx(this.toolShapeCenterX,this.toolShapeCenterY,this.angle,t,e)}getOutline(t){const e=t.data,i=e.length,s=[];let h=0,r=-1;for(let t=0;t<i;t+=4)r++,e[t+3]&&s.push([r,h,e.slice(t,t+4)]),r===this.w-1&&(h++,r=-1);return s}isPointInPath(t,e,i){return this.shape.isPointInPath(t,e,i)}draw(t=!1,e=0,i=0){this.ctx.clearRect(0,0,this.w,this.h),this.shape.draw(t,e,i)}}class S{width;height;gridGap;gridFillStyle;gridPaperGap;gridPaperStrokeStyle;quadrillePaperVerticalMargin;quadrillePaperGap;quadrillePaperStrokeStyles;gridPattern;gridPaperPattern;quadrillePaperPattern;bgPattern;canvas;ctx;coordX;coordY;constructor(t,e,i,s,h,r,a,o,n){this.width=t,this.height=e,this.gridGap=i,this.gridFillStyle=s,this.gridPaperGap=h,this.gridPaperStrokeStyle=r,this.quadrillePaperVerticalMargin=a,this.quadrillePaperGap=o,this.quadrillePaperStrokeStyles=n,this.canvas=d(t,e),this.ctx=this.canvas.getContext("2d"),this.gridPattern=this.generateGridPattern(),this.gridPaperPattern=this.generateGridPaperPattern(),this.quadrillePaperPattern=this.generateQuadrillePaperPattern()}resize(t,e){this.width=t,this.height=e,this.canvas.width=this.width,this.canvas.height=this.height}draw(e,i,s){if(e!==this.coordX||i!==this.coordY||s!==this.bgPattern){this.coordX=e,this.coordY=i,this.bgPattern=s;const h=this.ctx;h.clearRect(0,0,this.width+2*this.gridGap,this.height+2*this.gridGap),h.save(),h.beginPath(),h.translate(e,i),this.bgPattern===t.BGPattern.GRID?h.fillStyle=this.gridPattern:this.bgPattern===t.BGPattern.GRID_PAPER?h.fillStyle=this.gridPaperPattern:this.bgPattern===t.BGPattern.QUADRILLE_PAPER&&(h.fillStyle=this.quadrillePaperPattern),h.fillRect(0,0,this.width+2*this.gridGap,this.height+2*this.gridGap),h.restore()}}generateGridPattern(){const t=this.gridGap,e=new OffscreenCanvas(2*t,2*t),i=e.getContext("2d");i.fillStyle=this.gridFillStyle,i.fillRect(0,0,t,t),i.fillRect(t,t,t,t);return i.createPattern(e,"repeat")}generateGridPaperPattern(){const t=this.gridPaperGap,e=new OffscreenCanvas(t,t),i=e.getContext("2d");i.strokeStyle=this.gridPaperStrokeStyle,i.strokeRect(0,0,t,t),i.setLineDash([2,2]),i.beginPath(),i.moveTo(t/2,0),i.lineTo(t/2,t),i.moveTo(0,t/2),i.lineTo(t,t/2),i.stroke();return i.createPattern(e,"repeat")}generateQuadrillePaperPattern(){const t=this.quadrillePaperVerticalMargin,e=this.quadrillePaperGap,i=this.quadrillePaperStrokeStyles,s=2*t+3*e,h=new OffscreenCanvas(this.width,s),r=h.getContext("2d");for(let s=0;s<i.length;s++)r.strokeStyle=i[s],r.beginPath(),r.moveTo(0,t+e*s),r.lineTo(this.width,t+e*s),r.stroke();return r.createPattern(h,"repeat")}}class m{width;height;ruleStrokeStyle;ruleGap;ruleUnitLen;canvas;ctx;worldOffsetX;worldOffsetY;constructor(t,e,i,s,h){this.width=t,this.height=e,this.ruleStrokeStyle=i,this.ruleGap=s,this.ruleUnitLen=h,this.canvas=d(t,e),this.ctx=this.canvas.getContext("2d")}resize(t,e){this.width=t,this.height=e,this.canvas.width=this.width,this.canvas.height=this.height}draw(t,e){if(t!==this.worldOffsetX||e!==this.worldOffsetY){this.worldOffsetX=t,this.worldOffsetY=e;const i=this.ctx;i.beginPath(),i.clearRect(0,0,this.width,this.height),i.strokeStyle=this.ruleStrokeStyle,i.font="12px Arial",i.textAlign="center",i.fillStyle=this.ruleStrokeStyle;const s=c(this.worldOffsetX,10*this.ruleGap),h=c(this.worldOffsetY,10*this.ruleGap),r=(this.worldOffsetX-this.worldOffsetX%(10*this.ruleGap))/(10*this.ruleGap)*10,a=(this.worldOffsetY-this.worldOffsetY%(10*this.ruleGap))/(10*this.ruleGap)*10;let o=0,n=0,l=-s,d=-h;const g=3;for(;l<=this.width;){let t=this.ruleUnitLen;o%10?o%5||(t=1.5*this.ruleUnitLen):t=2.5*this.ruleUnitLen,i.moveTo(l,0),i.lineTo(l,t),i.moveTo(l,this.height),i.lineTo(l,this.height-t),o%10||(i.textBaseline="top",i.fillText(String(o+r),l,t+g),i.textBaseline="bottom",i.fillText(String(o+r),l,this.height-t-g)),l+=this.ruleGap,o++}for(i.textBaseline="middle";d<=this.height;){let t=this.ruleUnitLen;n%10?n%5||(t=1.5*this.ruleUnitLen):t=2.5*this.ruleUnitLen,i.moveTo(0,d),i.lineTo(t,d),i.moveTo(this.width,d),i.lineTo(this.width-t,d),n%10||(i.textAlign="left",i.fillText(String(n+a),t+g,d),i.textAlign="right",i.fillText(String(n+a),this.width-t-g,d)),d+=this.ruleGap,n++}i.stroke()}}}class P{store;canvas;ctx;scale=1;width;height;constructor(t,e,i){this.width=t*this.scale,this.height=e*this.scale,this.canvas=d(this.width,this.height),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high",this.store=i}resize(t,e){this.width=t,this.height=e,this.canvas.width=this.width,this.canvas.height=this.height}refresh(t,e){this.ctx.clearRect(0,0,this.width,this.height),this.putImageData(t,e)}singlePointsWriting(t){const e=this.ctx,{x:i,y:s,width:h,height:r,fragments:a}=t,o=e.getImageData(i,s,h,r),n=o.data,l=4*h;for(let t=0;t<a.length;t++){const{data:e}=a[t],i=l*t;for(let t=0;t<e.length;t+=4){const s=e[t+3],h=n[i+t+3];if(s||h){const r=e[t],a=e[t+1],o=e[t+2],l=n[i+t],c=n[i+t+1],d=n[i+t+2];if(s!==h||r!==l||a!==c||o!==d){const e=s/255,g=h/255,p=e+g*(1-e),u=this.colorOverlay(r,e,l,g,p),f=this.colorOverlay(a,e,c,g,p),w=this.colorOverlay(o,e,d,g,p);n[i+t+3]=255*p,n[i+t]=u,n[i+t+1]=f,n[i+t+2]=w}}}}this.ctx.putImageData(o,i,s)}colorOverlay(t,e,i,s,h){return(t*e+i*s*(1-e))/h}clear(){this.store.length=0,this.ctx.clearRect(0,0,this.width,this.height),this.pushImageData(0,0)}doClean(t,e,i,s,h,r=!1){t=this.scale*t,e=this.scale*e,i=this.scale*i,s=this.scale*s,h=this.scale*h;let a,o=!1;const n=Math.min(t,i)-h,l=Math.min(e,s)-h,c=Math.abs(i-t)+2*h,d=Math.abs(s-e)+2*h;if(r){a=this.ctx.getImageData(n,l,c,d).data}const g=this.ctx;if(g.save(),g.globalCompositeOperation="destination-out",g.lineWidth=2*h,g.lineCap="round",g.strokeStyle="#000",g.beginPath(),g.moveTo(t,e),g.lineTo(i,s),g.stroke(),g.restore(),r){const t=this.ctx.getImageData(n,l,c,d).data,e=t.length;for(let i=0;i<e;i+=4)if(t[i+3]!==a[i+3]){o=!0;break}}return o}pushImageData(t,e){const i=this.ctx.getImageData(0,0,this.width,this.height),s=i.data,h=[],r=s.length,a=4*this.width;let o=0;for(let t=0;t<r;t+=a){const e=s.subarray(t,t+a);let i=!1,r=!1,n=0,l=0;for(let t=0;t<a;t+=4)e[t+3]&&(i=!0,r||(r=!0,n=t),l=t);i&&h.push({data:e,index:o,startCol:n,endCol:l}),o++}const n=this.store;for(let i=n.length-1;i>=0;i--){const s=n[i];s.worldOffsetX===t&&s.worldOffsetY===e&&n.splice(i,1)}n.push({worldOffsetX:t,worldOffsetY:e,imageData:i,fragments:h,colLen:a,height:this.height}),this.washStore()}washStore(){const t=this.store,e=t[t.length-1],{worldOffsetX:i,worldOffsetY:s,colLen:h,height:r}=e,a=t.slice(0,t.length-1);for(let t=0;t<a.length;t++){const{fragments:e,worldOffsetX:o,worldOffsetY:n}=a[t],l=s-n,c=4*(i-o),d=c+h,g=l+r;for(let t=e.length-1;t>=0;t--){const i=e[t],{index:s}=i;if(s>=l&&s<g){const t=i.data,e=Math.min(t.length,d);for(let i=c;i<e;i+=4)t[i+3]&&(t[i+3]=0)}}}}putImageData(t,e){const i=this.width,s=this.height,h=4*i,r=h*s,a=this.store,o=a.length,n=new Uint8ClampedArray(r),l=[];for(let t=0;t<r;t+=h){const e=n.subarray(t,t+h);l.push(e)}const c=l.length;for(let i=0;i<o;i++){const s=a[i],r=s.worldOffsetX,o=s.worldOffsetY,n=s.fragments,d=n.length,g=4*(r-t),p=o-e;for(let t=0;t<d;t++){const{data:e,index:i,startCol:s,endCol:r}=n[t],a=p+i;if(a>=0&&a<c)for(let t=s;t<=r;t+=4){const i=g+t;if(i>=0&&i<h){e[t+3]&&!l[a][i+3]&&(l[a][i]=e[t],l[a][i+1]=e[t+1],l[a][i+2]=e[t+2],l[a][i+3]=e[t+3])}}}}if(o){const t=new ImageData(n,i,s);this.ctx.putImageData(t,0,0)}}getWholeCanvas(){const t=this.width,e=this.height,i=4*t,s=i*e,h=this.store,r=h.length;let a,o,n,l;for(let t=0;t<r;t++){const e=h[t],i=e.worldOffsetX,s=e.worldOffsetY;(void 0===a||a>i)&&(a=i),(void 0===o||o>s)&&(o=s),(void 0===n||n<i)&&(n=i),(void 0===l||l<s)&&(l=s)}const c=document.createElement("canvas");if(void 0===a||void 0===o||void 0===n||void 0===l)return c.width=0,c.height=0,c;n+=t,l+=e;const d=n-a,g=l-o,p=new Uint8ClampedArray(4*d*g);let u=d,f=g,w=0,S=0;for(let t=0;t<r;t++){const e=h[t],r=e.worldOffsetX,n=e.worldOffsetY,l=e.imageData.data;let c=0,g=0;for(let t=0;t<s;){const e=c-a+r,s=g-o+n,h=l[t],m=l[t+1],P=l[t+2],v=l[t+3];0!==v&&(e<u&&(u=e),s<f&&(f=s),e>w&&(w=e),s>S&&(S=s));const y=4*(e+s*d);p[y]=h,p[y+1]=m,p[y+2]=P,p[y+3]=v,t+=4,t%i?c++:(c=0,g+=1)}}const m=new ImageData(p,d,g),P=w-u,v=S-f;c.width=P,c.height=v;return c.getContext("2d").putImageData(m,-u,-f),c}getPaperCanvas(){const t=this.width,e=this.height,i=4*t,s=i*e,h=this.store,r=h.length,a=t;let o=0;for(let t=0;t<r;t++){const e=h[t].worldOffsetY;(void 0===o||o<e)&&(o=e)}o+=e;let n=0;const l=document.createElement("canvas"),c=a-0,d=new Uint8ClampedArray(4*c*(o-0));for(let t=0;t<r;t++){const e=h[t],r=e.worldOffsetX,l=e.worldOffsetY,g=e.imageData.data;let p=0,u=0;for(let t=0;t<s;){const e=p-0+r,s=u-0+l;if(e>=0&&s>=0&&e<a&&s<o){const i=g[t],h=g[t+1],r=g[t+2],a=g[t+3];0!==a&&s>n&&(n=s);const o=4*(e+s*c);d[o]=i,d[o+1]=h,d[o+2]=r,d[o+3]=a}t+=4,t%i?p++:(p=0,u+=1)}}const g=(Math.floor(n/e)+1)*e,p=new ImageData(d,a,o);l.width=a,l.height=g;return l.getContext("2d").putImageData(p,0,0),l}}let v=class{width;height;canvas;ctx;constructor(t,e){this.width=t,this.height=e,this.canvas=d(t,e),this.ctx=this.canvas.getContext("2d")}resize(t,e){this.width=t,this.height=e,this.canvas.width=this.width,this.canvas.height=this.height}draw(t,e,i){this.ctx.clearRect(0,0,this.width,this.height),this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle="rgba(0,0,0,.1)",this.ctx.strokeStyle="rgba(0,0,0,.15)",this.ctx.arc(t,e,i,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore(),this.ctx.beginPath()}};class y{writing;writeModel=t.WriteModel.WRITE;width;height;voice;color;x=null;y=null;d=null;prevX=null;prevY=null;prevD=null;constructor(t,e,i,s){this.writing=s,this.width=t,this.height=e,this.voice=i}reset(t){this.color=t}submit(){this.x=null,this.y=null,this.d=null,this.prevX=null,this.prevY=null,this.prevD=null}draw(t,{prevX:e,prevY:i,prevD:s,x:h,y:r,d:a}){const o=this.writing.ctx,n=h,l=r,c=a,d=e,g=i,p=s,u=Math.atan2(l-g,n-d),f=u-Math.PI/2,w=u+Math.PI/2,S=Math.max(p/2,.4),m=Math.max(c/2,.4),P=Math.cos(f)*S+d,v=Math.sin(f)*S+g,y=Math.cos(f)*m+n,T=Math.sin(f)*m+l,b=Math.cos(w)*m+n,x=Math.sin(w)*m+l,C=Math.cos(w)*S+d,O=Math.sin(w)*S+g;o.save(),o.fillStyle=this.color,o.strokeStyle=this.color,o.beginPath(),o.moveTo(P,v),o.lineTo(y,T),o.arc(n,l,m,f,w),o.lineTo(b,x),o.lineTo(C,O),o.arc(d,g,S,w,f),o.closePath(),o.fill(),o.restore()}generateD(t){t=Math.min(Math.max(.1,t),.9);return this.voice*(.5+1.5*(t-.1)/.8)}setPrev(t,e,i){const s=this.generateD(i);this.prevX=t,this.prevY=e,this.prevD=s}pushPoints({x:t,y:e,pressure:i,pointerType:s}){let h=this.prevX,r=this.prevY;const a=this.prevD;this.x=t,this.y=e;const o=this.generateD(i);this.d=o,this.draw(s,{prevX:h,prevY:r,prevD:a,x:t,y:e,d:o}),this.prevX=t,this.prevY=e,this.prevD=o}}const T=[[null,null],[null,null]],b=t.ScrollDirection.ALL,x=t.BGPattern.GRID,C=t.WriteModel.WRITE,O="rgb(250,250,250)",k="green",M=["rgba(0,0,255,.5)","rgba(255,0,0,.5)","rgba(0,0,255,1)","rgba(0,0,255,.5)"],D="rgba(0,0,0,0.5)",X="rgba(0,0,0,1)",Y="#333",A={scrollRange:T,scrollDirection:b,bgPattern:x,writeModel:C,enableBG:true,gridGap:100,gridPaperGap:100,quadrillePaperVerticalMargin:40,quadrillePaperGap:30,gridFillStyle:O,gridPaperStrokeStyle:k,quadrillePaperStrokeStyles:M,rule:true,ruleGap:10,ruleUnitLen:5,ruleStrokeStyle:D,voice:1,color:X,stack:false,cleanR:20,moveCountTotal:20,writeLocked:false,dragLocked:false,showBorder:true,borderStyle:Y,borderWidth:0,useShapeType:false,hash:""};class G{container;width;height;worldOffsetX=0;worldOffsetY=0;scrolling=!1;cleanState=!1;cleanX;cleanY;cleanPress=!1;stackObj;moveT=!1;debounceBindOnChange;toolShape;activateToolShape=!1;background;ruleAuxiliary;border;writing;eraser;eraserHasContent=!1;brushDrawing;scrollRange;scrollDirection;bgPattern;writeModel;enableBG;gridGap;gridPaperGap;quadrillePaperVerticalMargin;quadrillePaperGap;gridFillStyle;gridPaperStrokeStyle;quadrillePaperStrokeStyles;rule;ruleGap;ruleUnitLen;ruleStrokeStyle;voice;color;cleanR;stack;moveCountTotal;writeLocked;dragLocked;showBorder;borderStyle;borderWidth;useShapeType;containerOffset;onChange;store={};hash;justifyDus=[0,45,90,135,180,225,270,315,360];constructor(t,i=A){if(this.container=t,this.scrollRange=i.scrollRange??T,this.scrollDirection=i.scrollDirection??b,this.bgPattern=i.bgPattern??x,this.writeModel=i.writeModel??C,this.enableBG=i.enableBG??true,this.gridGap=i.gridGap??100,this.gridPaperGap=i.gridPaperGap??100,this.quadrillePaperVerticalMargin=i.quadrillePaperVerticalMargin??40,this.quadrillePaperGap=i.quadrillePaperGap??30,this.gridFillStyle=i.gridFillStyle??O,this.gridPaperStrokeStyle=i.gridPaperStrokeStyle??k,this.quadrillePaperStrokeStyles=i.quadrillePaperStrokeStyles??M,this.rule=i.rule??true,this.ruleGap=i.ruleGap??10,this.ruleUnitLen=i.ruleUnitLen??5,this.ruleStrokeStyle=i.ruleStrokeStyle??D,this.voice=i.voice??1,this.color=i.color??X,this.stack=i.stack??false,this.cleanR=i.cleanR??20,this.moveCountTotal=i.moveCountTotal??20,this.writeLocked=i.writeLocked??false,this.dragLocked=i.dragLocked??false,this.showBorder=i.showBorder??true,this.borderStyle=i.borderStyle??Y,this.borderWidth=i.borderWidth??0,this.useShapeType=i.useShapeType??false,this.hash=i.hash??"",this.containerOffset=i.containerOffset??(()=>{const t=document.scrollingElement,e=this.container.getBoundingClientRect();return{x:e.x+t.scrollLeft,y:e.y+t.scrollTop}}),this.onChange=i.onChange,this.debounceBindOnChange=function(t,e){let i;return function(...s){clearTimeout(i),i=setTimeout((()=>{t.apply(this,s)}),e)}}(this.triggerOnChange,500),this.loadEvent(),this.stack){const t=this.container.getBoundingClientRect(),i=Math.floor(t.width),s=Math.floor(t.height);this.stackObj=new e(i,s,this.hash),this.stackObj.restoreState=t=>{const e=t[t.length-1],i=this.worldOffsetX,s=this.worldOffsetY,h=e.worldOffsetX-i,r=e.worldOffsetY-s;if(h||r){const e=h/this.moveCountTotal,i=r/this.moveCountTotal;this.writing.store=t,this.moveT=!0,this.doMove(e,i)}else this.worldOffsetX=e.worldOffsetX,this.worldOffsetY=e.worldOffsetY,this.preStore=t,this.writing.store=t,this.draw()}}this.resize()}set preStore(t){const e=this.store,i=this.hash;e[i]||(e[i]=[]),e[i]=t}get preStore(){const t=this.store,e=this.hash;return t[e]||(t[e]=[]),t[e]}updateWorldOffset(t,e){this.worldOffsetX+=t,this.worldOffsetY+=e}updateHash(t){this.hash=t,this.stack&&this.stackObj.updateHash(t),this.writing.store=this.preStore,this.writing.refresh(this.worldOffsetX,this.worldOffsetY)}resize(){const t=this.container,e=t.getBoundingClientRect();this.width=Math.floor(e.width),this.height=Math.floor(e.height),this.enableBG&&(this.background?this.background.resize(this.width,this.height):(this.background=new S(this.width,this.height,this.gridGap,this.gridFillStyle,this.gridPaperGap,this.gridPaperStrokeStyle,this.quadrillePaperVerticalMargin,this.quadrillePaperGap,this.quadrillePaperStrokeStyles),this.container.append(this.background.canvas))),this.rule&&(this.ruleAuxiliary?this.ruleAuxiliary.resize(this.width,this.height):(this.ruleAuxiliary=new m(this.width,this.height,this.ruleStrokeStyle,this.ruleGap,this.ruleUnitLen),this.container.append(this.ruleAuxiliary.canvas))),this.writing?this.writing.resize(this.width,this.height):(this.writing=new P(this.width,this.height,this.preStore),this.container.append(this.writing.canvas)),this.useShapeType&&(this.toolShape?this.toolShape.resize(this.width,this.height):(this.toolShape=new w(this.width,this.height,this.voice,t,this.getPageCoords),this.container.append(this.toolShape.canvas))),this.eraser?this.eraser.resize(this.width,this.height):(this.eraser=new v(this.width,this.height),this.container.append(this.eraser.canvas)),this.brushDrawing=new y(this.width,this.height,this.voice,this.writing),this.stack&&(this.stackObj.width=this.width,this.stackObj.height=this.height),this.draw()}setVoice(t=1){this.voice=t,this.brushDrawing.voice=t,this.brushDrawing.d=t}showBG(){this.enableBG=!0,this.draw()}hideBG(){this.enableBG=!1,this.draw()}showRule(){this.rule=!0,this.draw()}hideRule(){this.rule=!1,this.draw()}showToolShape(){this.useShapeType=!0,this.drawToolShape()}hideToolShape(){this.useShapeType=!1,this.drawToolShape()}setToolShapeType(t){this.toolShape.toolShapeType=t,this.drawToolShape()}adjustOffset(){const[[t,e],[i,s]]=this.scrollRange;"number"==typeof t&&(this.worldOffsetX=Math.max(t,this.worldOffsetX)),"number"==typeof e&&(this.worldOffsetX=Math.min(e,this.worldOffsetX)),"number"==typeof i&&(this.worldOffsetY=Math.max(i,this.worldOffsetY)),"number"==typeof s&&(this.worldOffsetY=Math.min(s,this.worldOffsetY)),this.worldOffsetX=Math.round(this.worldOffsetX),this.worldOffsetY=Math.round(this.worldOffsetY)}doMove(e,i,s=0){this.scrollDirection===t.ScrollDirection.ALL?(this.worldOffsetX+=e,this.worldOffsetY+=i):this.scrollDirection===t.ScrollDirection.X?this.worldOffsetX+=e:this.scrollDirection===t.ScrollDirection.Y&&(this.worldOffsetY+=i),this.adjustOffset(),this.draw(),self.requestAnimationFrame((()=>{this.moveT&&s<this.moveCountTotal?this.doMove(e,i,++s):this.moveT=!1}))}scrollBy(t=0,e=0){if(!this.dragLocked){const i=t/this.moveCountTotal,s=e/this.moveCountTotal;this.moveT=!0,this.doMove(i,s)}}clear(){this.worldOffsetX=0,this.worldOffsetY=0,this.writing.clear(),this.draw(),this.stack&&this.stackObj.saveState([...this.writing.store])}triggerOnChange(){window.requestIdleCallback((()=>{if(this.onChange){const t=this.exportAsCanvas();this.onChange(t)}}))}exportAsCanvas(){return this.writing.getWholeCanvas()}exportAsPaperCanvas(){const t=this.writing.getPaperCanvas(),e=document.createElement("canvas");e.width=t.width,e.height=t.height;const i=e.getContext("2d");return this.enableBG&&this.loadBackground(i),i.drawImage(t,0,0),e}undo(){this.stack&&this.stackObj.undo()}redo(){this.stack&&this.stackObj.redo()}clean(){this.cleanState=!0}unclean(){this.cleanState=!1}draw(t=!1,e=0,i=0){this.enableBG&&this.loadBackground(),this.rule&&this.loadRule(),this.writing.refresh(this.worldOffsetX,this.worldOffsetY),this.drawEraser(),this.useShapeType&&this.drawToolShape(t,e,i),this.debounceBindOnChange()}doPushPoints(t,e,i){i.pointerType,this.brushDrawing.pushPoints({x:t,y:e,pressure:i.pressure,pointerType:i.pointerType})}loadEvent(){let e,i=!1,s=!1,h=!1,r=!1,a=0,o=0,n=0,c=0,d=0,g=!1;const p=(t,e)=>{const s=t.pageX,h=t.pageY;this.brushDrawing.reset(this.color),i=!1;let r=!1;if(this.useShapeType){r=this.toolShape.getNearestDistanceAndPoint(t.pageX,t.pageY,this.voice,this.color).conformingToDistance}!this.cleanState&&r?this.activateToolShape=!0:(!this.cleanState&&this.useShapeType&&this.toolShape.isPointInPath(t.pageX,t.pageY,"evenodd")?g=!1:this.cleanState||this.brushDrawing.setPrev(s,h,e.pressure),this.activateToolShape=!1),this.cleanState&&(this.cleanX=s,this.cleanY=h,this.cleanPress=!0,this.drawEraser())},u=t=>{this.moveT=!1,this.scrolling=!1;const i=t.touches,o=this.getPageCoords(i);let n=!1;if(c=o.pageX,d=o.pageY,2===i.length){if(s=!0,g=!1,this.dragLocked)return;performance.now(),this.cleanState&&(this.cleanPress=!1,this.draw()),this.useShapeType&&this.toolShape.isPointInPath(o.pageX,o.pageY,"nonzero")&&(n=!0),n?(h=!0,r=!1,e={x:o.pageX,y:o.pageY},a=Math.atan2(i[1].pageY-i[0].pageY,i[1].pageX-i[0].pageX)/Math.PI*180,a<0&&(a+=360)):h=!1}else 1!==i.length||this.writeLocked?g=!1:(this.useShapeType&&this.toolShape.isPointInPath(o.pageX,o.pageY,"evenodd")&&(n=!0),n?(h=!1,r=!0):r=!1,g=!0)},f=t=>{this.writing.singlePointsWriting(t)},w=(t,e)=>{const s=t.pageX,h=t.pageY;if(i=!0,this.cleanState)this.doClean(this.cleanX,this.cleanY,s,h),this.cleanX=s,this.cleanY=h,this.drawEraser();else if(this.useShapeType&&this.activateToolShape){const e=this.voice,{gatherAreasObj:i}=this.toolShape.getNearestDistanceAndPoint(t.pageX,t.pageY,e,this.color);f(i)}else this.doPushPoints(s,h,e)},S=i=>{const g=i.touches;if(s){if(this.dragLocked)return;o=c,n=d;const s=this.getPageCoords(g);if(c=s.pageX,d=s.pageY,performance.now(),this.useShapeType&&h){if(2===i.touches.length){let{angle:t}=function(t){const e=t.touches[0],i=t.touches[1],s=e.pageX,h=e.pageY,r=i.pageX,a=i.pageY,o=r-s,n=a-h;return{angle:Math.atan2(n,o)*(180/Math.PI),center:[(s+r)/2,(h+a)/2]}}(i);t<0&&(t+=360);let s=t-a;a=t;const[h,r]=l(e.x,e.y,s,this.toolShape.toolShapeCenterX,this.toolShape.toolShapeCenterY);this.toolShape.toolShapeCenterX=h,this.toolShape.toolShapeCenterY=r,this.toolShape.angle+=s,this.draw(!0,e.x,e.y)}}else{let e=0,i=0;this.scrollDirection===t.ScrollDirection.ALL?(e=c-o,i=d-n):this.scrollDirection===t.ScrollDirection.X?e=c-o:this.scrollDirection===t.ScrollDirection.Y&&(i=d-n),this.worldOffsetX-=e,this.worldOffsetY-=i,this.adjustOffset(),this.draw()}}else if(this.useShapeType&&r){o=c,n=d;const t=this.getPageCoords(g);c=t.pageX,d=t.pageY;const e=c-o,i=d-n;this.toolShape.toolShapeCenterX+=e,this.toolShape.toolShapeCenterY+=i,this.draw()}},m=i=>{if(s){if(this.dragLocked)return;this.scrollDirection===t.ScrollDirection.ALL||this.scrollDirection===t.ScrollDirection.X||(this.scrollDirection,t.ScrollDirection.Y)}if(this.useShapeType&&h){let t=this.toolShape.angle;t=(Math.floor(t)%360+360)%360;let i=!1;for(let e=0;e<this.justifyDus.length;e++){const s=this.justifyDus[e];if(Math.abs(s-t)<15){a=s,i=!0;break}}if(i){let i=a-t;const[s,h]=l(e.x,e.y,i,this.toolShape.toolShapeCenterX,this.toolShape.toolShapeCenterY);this.toolShape.toolShapeCenterX=s,this.toolShape.toolShapeCenterY=h,this.toolShape.angle+=i,this.draw(!0,e.x,e.y),setTimeout((()=>{this.draw()}),500)}else setTimeout((()=>{this.draw()}),500)}},P=t=>{const e=t.changedTouches;this.getPageCoords(e),m()},v=this.container;"ontouchstart"in self&&(v.addEventListener("touchstart",u,{passive:!0}),v.addEventListener("touchmove",S,{passive:!0}),v.addEventListener("touchend",P,{passive:!0})),v.addEventListener("pointerdown",(t=>{g=!0,t.preventDefault(),this.writeLocked||setTimeout((()=>{if(g){const{pageX:e,pageY:i}=t,s=this.getPageCoords([{pageX:e,pageY:i}]);p(s,t)}}))})),self.addEventListener("pointermove",(t=>{setTimeout((()=>{if(g&&(!this.useShapeType||!r)){const{pageX:e,pageY:i}=t,s=this.getPageCoords([{pageX:e,pageY:i}]);w(s,t)}}))})),self.addEventListener("pointerup",(t=>{this.brushDrawing.submit(),g&&(this.cleanState&&!this.eraserHasContent||(this.eraserHasContent=!1,this.writing.pushImageData(this.worldOffsetX,this.worldOffsetY),this.stack&&i&&this.stackObj.saveState(this.writing.store))),this.cleanState&&(this.cleanPress=!1,this.draw()),s=!1,g=!1,this.useShapeType&&(this.toolShape.prevPoint=null)}))}getPageCoords=t=>{const{x:e,y:i}=this.containerOffset(),s=t.length;let h=0,r=0;for(let a=0;a<s;a++){const s=t[a];h+=s.pageX-e,r+=s.pageY-i}return h/=s,r/=s,{pageX:h,pageY:r}};drawEraser(){this.cleanState&&this.cleanPress&&this.eraser.draw(this.cleanX,this.cleanY,this.cleanR),this.eraser.canvas.style.opacity=this.cleanState&&this.cleanPress?"1":"0"}doClean(t,e,i,s){this.writing.doClean(t,e,i,s,this.cleanR,!0)&&(this.eraserHasContent=!0)}loadBackground(t=null){let e,i=0,s=0;if(t){const i=t.canvas,{width:s,height:h}=i;e=new S(s,h,this.gridGap,this.gridFillStyle,this.gridPaperGap,this.gridPaperStrokeStyle,this.quadrillePaperVerticalMargin,this.quadrillePaperGap,this.quadrillePaperStrokeStyles)}else{i=-c(this.worldOffsetX,2*this.gridGap),s=-c(this.worldOffsetY,2*this.gridGap),e=this.background}this.enableBG&&(e.draw(i,s,this.bgPattern),t&&t.drawImage(e.canvas,0,0)),e.canvas.style.opacity=this.enableBG?"1":"0"}loadRule(){this.rule&&this.ruleAuxiliary.draw(this.worldOffsetX,this.worldOffsetY),this.ruleAuxiliary.canvas.style.opacity=this.rule?"1":"0"}drawToolShape(t=!1,e=0,i=0){this.toolShape.canvas.style.opacity=this.useShapeType?"1":"0",this.useShapeType&&this.toolShape.draw(t,e,i)}}t.Board=G,t.default=G,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.min.js.map
