!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).HandwritingBoard={})}(this,(function(t){"use strict";class e{width;height;undoStack=[];redoStack=[];constructor(t,e){this.width=t,this.height=e}restoreState=()=>{};saveState(t){this.undoStack.push([...t]),this.redoStack.length=0}undo(){if(this.undoStack.length>0){const t=this.undoStack.pop();this.redoStack.push(t);let e=this.undoStack[this.undoStack.length-1];if(!e){const t=new Uint8ClampedArray(4*this.width*this.height);e=[{worldOffsetX:0,worldOffsetY:0,imageData:new ImageData(t,this.width,this.height)}]}this.doRestoreState(e)}}redo(){if(this.redoStack.length>0){const t=this.redoStack.pop();this.undoStack.push(t),this.doRestoreState(t)}}doRestoreState(t){this.restoreState([...t])}}var i,s,r,h;function a(t,e,i){const s=t*Math.PI/180,r=Math.cos(s),h=Math.sin(s);return function(t,s){const a=t-e,o=s-i;return[a*r-o*h+e,a*h+o*r+i]}}function o(t,e){return(t+e)*(Math.PI/180)}function n(t,e,i,s,r){const h=s*(Math.PI/180),a=r*(Math.PI/180);return[t+i*Math.cos(h+a),e+i*Math.sin(h+a)]}function l(t,e){return(t%e+e)%e}function c(t,e){const i=document.createElement("canvas");return i.width=t,i.height=e,Object.assign(i.style,{left:"0",top:"0",position:"absolute","pointer-events":"none"}),i}t.WriteModel=void 0,(i=t.WriteModel||(t.WriteModel={})).WRITE="write",i.DRAW="draw",t.BGPattern=void 0,(s=t.BGPattern||(t.BGPattern={})).GRID="grid",s.GRID_PAPER="gridPaper",s.QUADRILLE_PAPER="quadrillePaper",t.ScrollDirection=void 0,(r=t.ScrollDirection||(t.ScrollDirection={})).ALL="all",r.X="x",r.Y="y",t.ShapeType=void 0,(h=t.ShapeType||(t.ShapeType={})).RULER="ruler",h.COMPASS="compass",h.COMPASS360="compass360",h.RIGHT_ANGLE_TRIANGLE="rightAngleTriangle",h.SOSCELESL_TRIANGLE="isoscelesTriangle";class d{ctx;cm;mm;path;width=0;height=0;marginH=0;degreeNumber=20;constructor(t,e,i){this.ctx=t,this.cm=e,this.mm=i,this.marginH=5*this.mm,this.width=this.cm*this.degreeNumber+2*this.marginH,this.height=2*this.cm}getOutlineCtx(t,e,i,s,r){const h=this.ctx.canvas,{width:a,height:o}=h,n=new OffscreenCanvas(a,o).getContext("2d"),l=this.generatorOuterBorder(t,e,i,s);return n.strokeStyle=r,n.lineWidth=s,n.stroke(l),n}generatorOuterBorder(t,e,i,s=0){const r=this.width+s,h=this.height+s,o=t-s/2-r/2,n=e-s/2-h/2,l=i,c=this.cm,d=a(l,t,e);let g="";g+=`M${d(o,n).join(",")}`,g+=`L${d(o+r,n).join(",")}`,g+=`L${d(o+r,n+h).join(",")}`;const p=1.5*c+this.marginH+s/2,u=o+r-p,f=n+h,w=o+p,m=2*c/3,P=m/4,S=f-P;g+=`L${d(u,f).join(",")}`;let v=u-m;for(;v>w;)g+=`C${[...d(v+m/3,S-P),...d(v+2*m/3,S+P),...d(v,f)].join(",")}`,v-=m;g+=`L${d(o,f).join(",")}`,g+="z";const x=new Path2D(g);return this.path=x,x}draw(t,e,i){const s=this.ctx,r=s.canvas,h=this.marginH,o=this.cm,n=this.mm,l=this.degreeNumber,c=this.width,d=this.height,g=a(i,t,e);s.clearRect(0,0,r.width,r.height),s.save(),s.beginPath(),s.fillStyle="rgba(0,0,0,.08)";const p=this.generatorOuterBorder(t,e,i);s.fill(p),s.restore(),s.save(),s.strokeStyle="black",s.font="3mm serif",s.textAlign="center",s.textBaseline="top",s.beginPath();const u=.5*o,f=t-c/2,w=e-d/2,m=w+u+n,P=.6*u,S=.8*u;for(let t=0;t<=l;t++){const e=f+h+t*o;if(s.moveTo(...g(e,w)),s.lineTo(...g(e,w+u)),s.save(),s.translate(...g(e,m)),s.rotate(i*Math.PI/180),s.fillText(String(t),0,0),s.restore(),t<l)for(let t=1;t<10;t++){const i=e+t*n;s.moveTo(...g(i,w)),5===t?s.lineTo(...g(i,w+S)):s.lineTo(...g(i,w+P))}}s.stroke(),s.restore()}isPointInPath(t,e,i){return this.ctx.isPointInPath(this.path,t,e,i)}}class g{ctx;cm;mm;container;getPageCoords;toolShape;path;outsideR;insideR;pointerW;startAngle=0;endAngle=360;firstPointerAngle=0;secondPointerAngle=30;pointer1;pointer2;cx;cy;angle;constructor(t,e,i,s,r,h){this.ctx=t,this.cm=e,this.mm=i,this.container=s,this.getPageCoords=r,this.toolShape=h,this.outsideR=6*e,this.insideR=4.5*e,this.pointerW=1*e,this.loadEvent()}calculateRotationAngle(t,e,i,s,r,h){const a=i-t,o=s-e,n=r-t,l=h-e,c=(a*n+o*l)/(Math.sqrt(a*a+o*o)*Math.sqrt(n*n+l*l)),d=Math.acos(c);return 180*(a*l-o*n>=0?d:-d)/Math.PI}loadEvent(){const t=this.container;let e=0,i=0,s=0,r=0,h=!1,a=!1,o=!1;const n=(t,e)=>{const i=this.ctx,n=this.pointer1,l=this.pointer2;s=t.pageX,r=t.pageY,i.isPointInPath(l,t.pageX,t.pageY)?(e.stopImmediatePropagation(),o=!0,h=!0):i.isPointInPath(n,t.pageX,t.pageY)&&(e.stopImmediatePropagation(),a=!0,h=!0)},l=t=>{const e=t.touches,i=this.getPageCoords(e);1===e.length?n(i,t):h=!1},c=t=>{t.preventDefault();const{pageX:e,pageY:i}=t,s=this.getPageCoords([{pageX:e,pageY:i}]);n(s,t)},d=t=>{e=s,i=r,s=t.pageX,r=t.pageY;const h=this.calculateRotationAngle(this.cx,this.cy,e,i,s,r);a?this.firstPointerAngle+=h:o&&(this.secondPointerAngle+=h),this.draw(this.cx,this.cy,this.angle),this.toolShape.reset()},g=t=>{if(h){t.stopImmediatePropagation();const{pageX:e,pageY:i}=t,s=this.getPageCoords([{pageX:e,pageY:i}]);d(s)}},p=t=>{if(h){t.stopImmediatePropagation();const e=t.touches,i=this.getPageCoords(e);d(i)}},u=()=>{h=!1,a=!1,o=!1},f=()=>{u()},w=t=>{u()};"ontouchstart"in self?(t.addEventListener("touchstart",l,{passive:!0}),t.addEventListener("touchmove",p,{passive:!0}),t.addEventListener("touchend",f,{passive:!0})):(t.addEventListener("mousedown",c),self.addEventListener("mousemove",g,{passive:!0}),self.addEventListener("mouseup",w,{passive:!0}))}getOutlineCtx(t,e,i,s,r){const h=this.ctx.canvas,{width:a,height:o}=h,n=new OffscreenCanvas(a,o).getContext("2d"),l=t,c=e,d=i;this.drawBorder(n,l,c,d,0,"rgba(0,0,0,1)"),this.drawPointer(n,l,c,d,this.firstPointerAngle,0,"rgba(0,0,0,1)"),this.drawPointer(n,l,c,d,this.secondPointerAngle,0,"rgba(0,0,0,1)"),n.globalCompositeOperation="source-out";const g=new OffscreenCanvas(a,o),p=g.getContext("2d");return this.drawBorder(p,l,c,d,s,"rgba(0,0,0,1)"),this.drawPointer(p,l,c,d,this.firstPointerAngle,s,"rgba(0,0,0,1)"),this.drawPointer(p,l,c,d,this.secondPointerAngle,s,"rgba(0,0,0,1)"),n.drawImage(g,0,0),n.globalCompositeOperation="source-in",n.fillStyle=r,n.fillRect(0,0,a,o),n}generatorOuterBorder(t,e,i){const s=this.startAngle,r=this.endAngle,h=(this.outsideR+this.insideR)/2,a=t,n=e,l=new Path2D;return l.arc(a,n,h,o(s,i),o(r,i)),this.path=l,l}generatorPointer(t,e,i,s,r){const h=this.outsideR,o=t,n=e,l=this.pointerW/2+r;let c=i;c+=s;const d=a(c,t,e);let g="";g+=`M${d(o,n-l).join(",")}`,g+=`A${l},${l},1,1,1,${d(o,n+l).join(",")}`,g+=`L${d(o-h,n+l).join(",")}`,g+=`A${l},${l},1,1,1,${d(o-h,n-l).join(",")}`,g+="z";return new Path2D(g)}drawDegree(t,e,i,s,r,h,a,o,n,l,c,d,g,p,u){const f=this.ctx,w=360,m=2*Math.PI/w;let P=(180+p)*Math.PI/180;f.save(),f.textAlign="center",f.textBaseline="middle",f.font=`${a}px Arial`,g||(i+=h,f.textBaseline="bottom");for(let a=0;a<=w;a++){if(a%10==0){const s=t+Math.cos(P)*(i-h),r=e+Math.sin(P)*(i-h),l=t+Math.cos(P)*i,c=e+Math.sin(P)*i;if(d&&(f.beginPath(),f.moveTo(s,r),f.lineTo(l,c),f.stroke()),a!==w&&n&&a%10==0){const s=t+Math.cos(P)*(i-(h+o)*Number(g)),r=e+Math.sin(P)*(i-(h+o)*Number(g));f.save(),f.textAlign="center",f.translate(s,r),f.rotate(P+Math.PI/2),f.fillText((u?w-a:a).toString(),0,0),f.restore()}}else if(a%5){if(l){const r=t+Math.cos(P)*(i-s),h=e+Math.sin(P)*(i-s),a=t+Math.cos(P)*i,o=e+Math.sin(P)*i;f.beginPath(),f.moveTo(r,h),f.lineTo(a,o),f.stroke()}}else if(c){const s=t+Math.cos(P)*(i-r),h=e+Math.sin(P)*(i-r),a=t+Math.cos(P)*i,o=e+Math.sin(P)*i;f.beginPath(),f.moveTo(s,h),f.lineTo(a,o),f.stroke()}P+=m}f.restore()}drawContent(t,e,i){const s=this.outsideR,r=t,h=e,a=this.ctx;a.save(),this.drawDegree(r,h,s,10,15,20,8,10,!0,!0,!0,!0,!0,i,!1),this.drawDegree(r,h,s,10,15,20,8,25,!0,!1,!1,!1,!0,i,!0),a.restore()}drawBorder(t,e,i,s,r,h){const a=this.outsideR,o=this.insideR;t.save(),t.beginPath(),t.lineWidth=a-o+2*r,t.strokeStyle=h;const n=this.generatorOuterBorder(e,i,s);t.stroke(n),t.restore()}drawPointer(t,e,i,s,r,h,a){t.save(),t.beginPath(),t.fillStyle=a;const o=this.generatorPointer(e,i,s,r,h);return t.fill(o),t.restore(),o}drawFixedPoint(t,e,i){const s=this.ctx;s.save(),s.beginPath(),s.fillStyle="rgba(0,0,0,.08)",s.arc(t,e,this.pointerW/4,0,2*Math.PI),s.fill(),s.restore()}draw(t,e,i){const s=this.ctx,r=s.canvas;s.clearRect(0,0,r.width,r.height),this.drawBorder(s,t,e,i,0,"rgba(0,0,0,.08)"),this.drawContent(t,e,i),this.pointer1=this.drawPointer(s,t,e,i,this.firstPointerAngle,0,"rgba(0,0,0,.08)"),this.pointer2=this.drawPointer(s,t,e,i,this.secondPointerAngle,0,"rgba(0,0,0,.08)"),this.drawFixedPoint(t,e,i),this.cx=t,this.cy=e,this.angle=i}isPointInPath(t,e,i){const s=this.ctx;if("evenodd"===i){let i=!1;return s.save(),s.lineWidth=this.outsideR-this.insideR,i=s.isPointInStroke(this.path,t,e),s.restore(),i}return s.isPointInPath(this.path,t,e)}}class p{ctx;cm;mm;degreeNumberH;degreeNumberV;marginH;marginV;path;width=0;height=0;marginC=0;gap=0;constructor(t,e,i,s,r,h,a){this.ctx=t,this.cm=e,this.mm=i,this.degreeNumberH=s,this.degreeNumberV=r,this.marginH=h,this.marginV=a,this.marginC=this.cm,this.width=this.cm*this.degreeNumberH+this.marginH+this.marginC,this.height=this.cm*this.degreeNumberV+this.marginV+this.marginC,this.gap=1.5*this.cm}getOutlineCtx(t,e,i,s,r){const h=this.ctx.canvas,{width:a,height:o}=h,n=new OffscreenCanvas(a,o).getContext("2d"),l=this.generatorOuterBorder(t,e,i,s);return n.strokeStyle=r,n.lineWidth=s,n.stroke(l),n}generatorOuterBorder(t,e,i,s=0){const r=this.width+s,h=this.height+s,o=t-s/2-r/2,n=e-s/2-h/2,l=a(i,t,e),c=new Path2D;c.moveTo(...l(o+r,n)),c.lineTo(...l(o,n)),c.lineTo(...l(o,n+h)),c.closePath();const d=this.gap,g=o+d,p=n+d,u=r/2,f=h/2;return c.moveTo(...l(g+u,p)),c.lineTo(...l(g,p)),c.lineTo(...l(g,p+f)),c.closePath(),this.path=c,c}draw(t,e,i){const s=this.ctx,r=s.canvas,h=this.marginC,o=this.cm,n=this.mm,l=this.degreeNumberH,c=this.degreeNumberV,d=this.width,g=this.height,p=a(i,t,e);s.clearRect(0,0,r.width,r.height),s.save(),s.beginPath(),s.fillStyle="rgba(0,0,0,.08)";const u=this.generatorOuterBorder(t,e,i);s.fill(u,"evenodd"),s.restore(),s.save(),s.strokeStyle="black",s.font="3mm serif",s.textAlign="center",s.textBaseline="top",s.beginPath();const f=.5*o,w=t-d/2,m=e-g/2,P=.6*f,S=.8*f;for(let t=0;t<=l;t++){const e=w+h+t*o;if(s.moveTo(...p(e,m)),s.lineTo(...p(e,m+f)),s.save(),s.translate(...p(e,m+f+n)),s.rotate(i*Math.PI/180),s.fillText(String(t),0,0),s.restore(),t<l)for(let t=1;t<10;t++){const i=e+t*n;s.moveTo(...p(i,m)),5===t?s.lineTo(...p(i,m+S)):s.lineTo(...p(i,m+P))}}for(let t=0;t<=c;t++){const e=m+h+t*o;if(s.moveTo(...p(w,e)),s.lineTo(...p(w+f,e)),s.save(),s.translate(...p(w+f+n,e)),s.rotate(i*Math.PI/180-Math.PI/2),s.fillText(String(t),0,0),s.restore(),t<c)for(let t=1;t<10;t++){const i=e+t*n;s.moveTo(...p(w,i)),5===t?s.lineTo(...p(w+S,i)):s.lineTo(...p(w+P,i))}}s.stroke(),s.restore()}isPointInPath(t,e,i){return this.ctx.isPointInPath(this.path,t,e,i)}}class u{w;h;voice;canvas;ctx;getNearestDistanceAndPointVoice;outlineCtx;outlineImageData;outline;outlineMap;longestDistance=30;gatherAreaWidth=10;prevPoint=null;_x;_y;_angle;_toolShapeType;strokeStyle;cm=0;mm=0;width=0;height=0;marginH=0;degreeNumber=20;ruler;compass;compass360;rightAngleTriangle;isoscelesTriangle;constructor(t,e,i,s,r){this.w=t,this.h=e,this.voice=i,this.canvas=c(t,e),this.ctx=this.canvas.getContext("2d"),this.cm=96/2.54,this.mm=this.cm/10,this.getNearestDistanceAndPointVoice=i,this.ruler=new d(this.ctx,this.cm,this.mm),this.compass=new class{ctx;cm;mm;path;r;middleR;smallR;middleGap;startAngle=170;endAngle=370;innerStartAngle=180;innerEndAngle=360;constructor(t,e,i){this.ctx=t,this.cm=e,this.mm=i,this.r=6*e,this.middleR=3.5*e,this.middleGap=1*e,this.smallR=2.2*e}getOutlineCtx(t,e,i,s,r){const h=this.ctx.canvas,{width:a,height:o}=h,n=new OffscreenCanvas(a,o).getContext("2d"),l=this.generatorOuterBorder(t,e,i,s);return n.strokeStyle=r,n.lineWidth=s,n.stroke(l),n}generatorOuterBorder(t,e,i,s=0){const r=this.startAngle,h=this.endAngle,a=this.innerStartAngle,l=this.innerEndAngle,c=this.r+s,d=this.middleR+s,g=d+this.middleGap-s,p=this.smallR-s,u=t,f=e,w=t,m=e-s,P=new Path2D;return P.arc(u,f,c,o(r,i),o(h,i)),P.closePath(),P.moveTo(...n(w,m,g,a,i)),P.arc(w,m,g,o(a,i),o(l,i)),P.lineTo(...n(w,m,d,l,i)),P.arc(w,m,d,o(l,i),o(a,i),!0),P.lineTo(...n(w,m,g,a,i)),P.moveTo(...n(w,m,p,a,i)),P.arc(w,m,p,o(a,i),o(l,i)),P.closePath(),this.path=P,P}drawDegree(t,e,i,s,r,h,a,o,n,l,c,d,g,p=!1){const u=this.ctx,f=Math.PI/180;let w=(180+g)*Math.PI/180;u.save(),u.textAlign="center",u.textBaseline="middle",u.font=`${a}px Arial`,d||(i+=h,u.textBaseline="bottom");for(let a=0;a<=180;a++){if(a%10==0){const s=t+Math.cos(w)*(i-h),r=e+Math.sin(w)*(i-h),l=t+Math.cos(w)*i,c=e+Math.sin(w)*i;if(u.beginPath(),u.moveTo(s,r),u.lineTo(l,c),u.stroke(),n&&a%10==0){const s=t+Math.cos(w)*(i-(h+o)*Number(d)),r=e+Math.sin(w)*(i-(h+o)*Number(d));u.save(),u.textAlign="center",u.translate(s,r),u.rotate(w+Math.PI/2),u.fillText((p?180-a:a).toString(),0,0),u.restore()}}else if(a%5){if(l){const r=t+Math.cos(w)*(i-s),h=e+Math.sin(w)*(i-s),a=t+Math.cos(w)*i,o=e+Math.sin(w)*i;u.beginPath(),u.moveTo(r,h),u.lineTo(a,o),u.stroke()}}else if(c){const s=t+Math.cos(w)*(i-r),h=e+Math.sin(w)*(i-r),a=t+Math.cos(w)*i,o=e+Math.sin(w)*i;u.beginPath(),u.moveTo(s,h),u.lineTo(a,o),u.stroke()}w+=f}u.restore()}drawContent(t,e,i){const s=this.r,r=this.middleR,h=this.smallR,a=t,o=e,n=this.ctx;n.save(),this.drawDegree(a,o,s,10,15,20,8,10,!0,!0,!0,!0,i),this.drawDegree(a,o,r,10,12,15,0,0,!1,!0,!0,!0,i),this.drawDegree(a,o,h,0,0,12,7,10,!0,!1,!1,!1,i,!0),n.restore()}drawPosition(t,e,i){const s=this.ctx;s.save(),s.beginPath(),s.moveTo(t,e),s.lineTo(...n(t,e,20,90,i)),s.stroke(),s.beginPath(),s.arc(t,e,20,o(0,i),o(180,i)),s.stroke(),s.restore()}draw(t,e,i){const s=this.ctx,r=s.canvas;s.clearRect(0,0,r.width,r.height),s.save(),s.beginPath(),s.fillStyle="rgba(0,0,0,.08)";const h=this.generatorOuterBorder(t,e,i);s.fill(h,"evenodd"),s.restore(),this.drawContent(t,e,i),this.drawPosition(t,e,i)}isPointInPath(t,e,i){return this.ctx.isPointInPath(this.path,t,e,i)}}(this.ctx,this.cm,this.mm),this.compass360=new g(this.ctx,this.cm,this.mm,s,r,this),this.rightAngleTriangle=new p(this.ctx,this.cm,this.mm,9,5,3*this.cm,1*this.cm),this.isoscelesTriangle=new p(this.ctx,this.cm,this.mm,6,6,2*this.cm,2*this.cm)}set x(t){this._x=t,this.reset()}get x(){return this._x}set y(t){this._y=t,this.reset()}get y(){return this._y}set angle(t){this._angle=t,this.reset()}get angle(){return this._angle}set toolShapeType(t){this._toolShapeType=t,this.reset()}get toolShapeType(){return this._toolShapeType}get shape(){let e;switch(this.toolShapeType){case t.ShapeType.RULER:e=this.ruler;break;case t.ShapeType.COMPASS:e=this.compass;break;case t.ShapeType.COMPASS360:e=this.compass360;break;case t.ShapeType.RIGHT_ANGLE_TRIANGLE:e=this.rightAngleTriangle;break;case t.ShapeType.SOSCELESL_TRIANGLE:e=this.isoscelesTriangle;break;default:e=this.ruler}return e}reset(){this.outline=null,this.prevPoint=null}getGathers(t,e,i,s,r){const h=Math.min(t,i)-r/2,a=Math.min(e,s)-r/2,o=Math.max(t,i)+r/2,n=Math.max(e,s)+r/2,l=[];for(let t=h;t<=o;t++)for(let e=a;e<=n;e++)l.push([t,e]);return l}getNearestDistanceAndPoint(t,e,i,s){this.outline&&i===this.getNearestDistanceAndPointVoice&&this.strokeStyle===s||(this.getNearestDistanceAndPointVoice=i,this.strokeStyle=s,this.outlineCtx=this.getOutlineCtx(this.getNearestDistanceAndPointVoice,s),this.outlineImageData=this.outlineCtx.getImageData(0,0,this.w,this.h),this.outline=this.getOutline(this.outlineImageData),this.outlineMap=this.getOutlineMap(this.outline));const r=this.outline,h=r.length;let a=this.prevPoint;const o=this.gatherAreaWidth;if(a){const i=[];for(let t=0;t<h;t++){const[e,s]=r[t];((a[0]-e)**2+(a[1]-s)**2)**.5<=o&&i.push(r[t])}let s=Number.MAX_SAFE_INTEGER,n=null;for(let r=0;r<i.length;r++){const[h,a]=i[r],o=((t-h)**2+(e-a)**2)**.5;o<s&&(s=o,n=[h,a])}let l=[];n&&(l=this.getGathers(a[0],a[1],n[0],n[1],o));const c=[],d=l.length;for(let t=0;t<d;t++){const e=l[t],i=this.outlineMap?.[e[0]]?.[e[1]];if(i){const t=i;c.push({x:e[0],y:e[1],fillStyle:`rgba(${t[0]},${t[1]},${t[2]},${t[3]/255})`})}}return this.prevPoint=n,{conformingToDistance:!0,drawPoints:c}}{let i=Number.MAX_SAFE_INTEGER;for(let s=0;s<h;s++){const[h,o]=r[s],n=((t-h)**2+(e-o)**2)**.5;n<i&&(i=n,a=[h,o])}return this.prevPoint=a,{conformingToDistance:i<=this.longestDistance,drawPoints:[]}}}getOutlineCtx(t,e){return this.shape.getOutlineCtx(this._x,this._y,this._angle,t,e)}getOutline(t){const e=t.data,i=e.length,s=[];let r=0,h=-1;for(let t=0;t<i;t+=4)h++,e[t+3]&&s.push([h,r,e.slice(t,t+4)]),h===this.w-1&&(r++,h=-1);return s}getOutlineMap(t){const e={},i=t.length;for(let s=0;s<i;s++){const[i,r,h]=t[s];e[i]||(e[i]={}),e[i][r]=h}return e}isPointInPath(t,e,i){return this.shape.isPointInPath(t,e,i)}draw(t,e,i,s){if(this.x!==t||this.y!==e||this.angle!==i||this.toolShapeType!==s){this.x=t,this.y=e,this.angle=i,this.toolShapeType=s;this.ctx.clearRect(0,0,this.w,this.h),this.shape.draw(this._x,this._y,this._angle)}}}class f{width;height;gridGap;gridFillStyle;gridPaperGap;gridPaperStrokeStyle;quadrillePaperVerticalMargin;quadrillePaperGap;quadrillePaperStrokeStyles;gridPattern;gridPaperPattern;quadrillePaperPattern;bgPattern;canvas;ctx;coordX;coordY;constructor(t,e,i,s,r,h,a,o,n){this.width=t,this.height=e,this.gridGap=i,this.gridFillStyle=s,this.gridPaperGap=r,this.gridPaperStrokeStyle=h,this.quadrillePaperVerticalMargin=a,this.quadrillePaperGap=o,this.quadrillePaperStrokeStyles=n,this.canvas=c(t,e),this.ctx=this.canvas.getContext("2d"),this.gridPattern=this.generateGridPattern(),this.gridPaperPattern=this.generateGridPaperPattern(),this.quadrillePaperPattern=this.generateQuadrillePaperPattern()}draw(e,i,s){if(e!==this.coordX||i!==this.coordY||s!==this.bgPattern){this.coordX=e,this.coordY=i,this.bgPattern=s;const r=this.ctx;r.clearRect(0,0,this.width+2*this.gridGap,this.height+2*this.gridGap),r.save(),r.beginPath(),r.translate(e,i),this.bgPattern===t.BGPattern.GRID?r.fillStyle=this.gridPattern:this.bgPattern===t.BGPattern.GRID_PAPER?r.fillStyle=this.gridPaperPattern:this.bgPattern===t.BGPattern.QUADRILLE_PAPER&&(r.fillStyle=this.quadrillePaperPattern),r.fillRect(0,0,this.width+2*this.gridGap,this.height+2*this.gridGap),r.restore()}}generateGridPattern(){const t=this.gridGap,e=new OffscreenCanvas(2*t,2*t),i=e.getContext("2d");i.fillStyle=this.gridFillStyle,i.fillRect(0,0,t,t),i.fillRect(t,t,t,t);return i.createPattern(e,"repeat")}generateGridPaperPattern(){const t=this.gridPaperGap,e=new OffscreenCanvas(t,t),i=e.getContext("2d");i.strokeStyle=this.gridPaperStrokeStyle,i.strokeRect(0,0,t,t),i.setLineDash([2,2]),i.beginPath(),i.moveTo(t/2,0),i.lineTo(t/2,t),i.moveTo(0,t/2),i.lineTo(t,t/2),i.stroke();return i.createPattern(e,"repeat")}generateQuadrillePaperPattern(){const t=this.quadrillePaperVerticalMargin,e=this.quadrillePaperGap,i=this.quadrillePaperStrokeStyles,s=2*t+3*e,r=new OffscreenCanvas(this.width,s),h=r.getContext("2d");for(let s=0;s<i.length;s++)h.strokeStyle=i[s],h.beginPath(),h.moveTo(0,t+e*s),h.lineTo(this.width,t+e*s),h.stroke();return h.createPattern(r,"repeat")}}class w{width;height;ruleStrokeStyle;ruleGap;ruleUnitLen;canvas;ctx;worldOffsetX;worldOffsetY;constructor(t,e,i,s,r){this.width=t,this.height=e,this.ruleStrokeStyle=i,this.ruleGap=s,this.ruleUnitLen=r,this.canvas=c(t,e),this.ctx=this.canvas.getContext("2d")}draw(t,e){if(t!==this.worldOffsetX||e!==this.worldOffsetY){this.worldOffsetX=t,this.worldOffsetY=e;const i=this.ctx;i.beginPath(),i.clearRect(0,0,this.width,this.height),i.strokeStyle=this.ruleStrokeStyle,i.font="12px Arial",i.textAlign="center",i.fillStyle=this.ruleStrokeStyle;const s=l(this.worldOffsetX,10*this.ruleGap),r=l(this.worldOffsetY,10*this.ruleGap),h=(this.worldOffsetX-this.worldOffsetX%(10*this.ruleGap))/(10*this.ruleGap)*10,a=(this.worldOffsetY-this.worldOffsetY%(10*this.ruleGap))/(10*this.ruleGap)*10;let o=0,n=0,c=-s,d=-r;const g=3;for(;c<=this.width;){let t=this.ruleUnitLen;o%10?o%5||(t=1.5*this.ruleUnitLen):t=2.5*this.ruleUnitLen,i.moveTo(c,0),i.lineTo(c,t),i.moveTo(c,this.height),i.lineTo(c,this.height-t),o%10||(i.textBaseline="top",i.fillText(String(o+h),c,t+g),i.textBaseline="bottom",i.fillText(String(o+h),c,this.height-t-g)),c+=this.ruleGap,o++}for(i.textBaseline="middle";d<=this.height;){let t=this.ruleUnitLen;n%10?n%5||(t=1.5*this.ruleUnitLen):t=2.5*this.ruleUnitLen,i.moveTo(0,d),i.lineTo(t,d),i.moveTo(this.width,d),i.lineTo(this.width-t,d),n%10||(i.textAlign="left",i.fillText(String(n+a),t+g,d),i.textAlign="right",i.fillText(String(n+a),this.width-t-g,d)),d+=this.ruleGap,n++}i.stroke()}}}class m{width;height;borderStyle;borderWidth;canvas;ctx;constructor(t,e,i,s){this.width=t,this.height=e,this.borderStyle=i,this.borderWidth=s,this.canvas=c(t,e),this.ctx=this.canvas.getContext("2d"),this.draw()}draw(){const t=this.ctx;t.strokeStyle=this.borderStyle,t.lineWidth=this.borderWidth,t.strokeRect(0,0,this.width,this.height)}}class P{width;height;store=[];canvas;ctx;constructor(t,e){this.width=t,this.height=e,this.canvas=c(t,e),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0})}refresh(t,e){this.ctx.clearRect(0,0,this.width,this.height),this.putImageData(t,e)}singlePointsWriting(t){const e=this.ctx,i=t.length;for(let s=0;s<i;s++){e.save(),e.beginPath();const{x:i,y:r,fillStyle:h}=t[s];e.fillStyle=h,e.fillRect(i,r,1,1),e.restore()}}writing(t,e){this.ctx.save(),this.ctx.fillStyle=e,this.ctx.beginPath();const[[i,s],[r,h],[a,o],[n,l]]=t,c=i,d=s,g=r,p=h,u=a,f=o,w=n,m=l;this.ctx.moveTo(c,d),this.ctx.lineTo(g,p),this.ctx.lineTo(w,m),this.ctx.lineTo(u,f),this.ctx.fill(),this.ctx.restore()}clear(){this.store.length=0,this.doClean(0,0,this.width,this.height),this.pushImageData(0,0)}doClean(t,e,i,s,r=!1){let h=!1;if(r){const r=this.ctx.getImageData(t,e,i,s).data,a=r.length;for(let t=0;t<a;t+=4)if(r[t+3]){h=!0;break}}return this.ctx.clearRect(t,e,i,s),h}pushImageData(t,e){const i=this.ctx.getImageData(0,0,this.width,this.height),s=this.store;for(let i=s.length-1;i>=0;i--){const r=s[i];r.worldOffsetX===t&&r.worldOffsetY===e&&s.splice(i,1)}s.push({worldOffsetX:t,worldOffsetY:e,imageData:i})}putImageData(t,e){const i=this.width,s=this.height,r=4*i,h=r*s,a=this.store,o=a.length,n=new Uint8ClampedArray(h);for(let l=0;l<o;l++){const o=a[l],c=o.worldOffsetX,d=o.worldOffsetY,g=o.imageData.data;if(Math.abs(c-t)>=i||Math.abs(d-e)>=s)continue;let p=0,u=0;for(let a=0;a<h;){const h=p-t+c,o=u-e+d;if(h>=0&&o>=0&&h<i&&o<s){const t=g[a],e=g[a+1],s=g[a+2],r=g[a+3],l=4*(h+o*i);n[l]=t,n[l+1]=e,n[l+2]=s,n[l+3]=r}a+=4,a%r?p++:(p=0,u+=1)}}const l=new ImageData(n,i,s);this.ctx.putImageData(l,0,0)}getWholeCanvas(){const t=this.width,e=this.height,i=4*t,s=i*e,r=this.store,h=r.length;let a,o,n,l;for(let t=0;t<h;t++){const e=r[t],i=e.worldOffsetX,s=e.worldOffsetY;(void 0===a||a>i)&&(a=i),(void 0===o||o>s)&&(o=s),(void 0===n||n<i)&&(n=i),(void 0===l||l<s)&&(l=s)}const c=document.createElement("canvas");if(void 0===a||void 0===o||void 0===n||void 0===l)return c.width=0,c.height=0,c;n+=t,l+=e;const d=n-a,g=l-o,p=new Uint8ClampedArray(4*d*g);let u=d,f=g,w=0,m=0;for(let t=0;t<h;t++){const e=r[t],h=e.worldOffsetX,n=e.worldOffsetY,l=e.imageData.data;let c=0,g=0;for(let t=0;t<s;){const e=c-a+h,s=g-o+n,r=l[t],P=l[t+1],S=l[t+2],v=l[t+3];0!==v&&(e<u&&(u=e),s<f&&(f=s),e>w&&(w=e),s>m&&(m=s));const x=4*(e+s*d);p[x]=r,p[x+1]=P,p[x+2]=S,p[x+3]=v,t+=4,t%i?c++:(c=0,g+=1)}}const P=new ImageData(p,d,g),S=w-u,v=m-f;c.width=S,c.height=v;return c.getContext("2d").putImageData(P,-u,-f),c}getPaperCanvas(){const t=this.width,e=this.height,i=4*t,s=i*e,r=this.store,h=r.length,a=t;let o=0;for(let t=0;t<h;t++){const e=r[t].worldOffsetY;(void 0===o||o<e)&&(o=e)}o+=e;let n=0;const l=document.createElement("canvas"),c=a-0,d=new Uint8ClampedArray(4*c*(o-0));for(let t=0;t<h;t++){const e=r[t],h=e.worldOffsetX,l=e.worldOffsetY,g=e.imageData.data;let p=0,u=0;for(let t=0;t<s;){const e=p-0+h,s=u-0+l;if(e>=0&&s>=0&&e<a&&s<o){const i=g[t],r=g[t+1],h=g[t+2],a=g[t+3];0!==a&&s>n&&(n=s);const o=4*(e+s*c);d[o]=i,d[o+1]=r,d[o+2]=h,d[o+3]=a}t+=4,t%i?p++:(p=0,u+=1)}}const g=(Math.floor(n/e)+1)*e,p=new ImageData(d,a,o);l.width=a,l.height=g;return l.getContext("2d").putImageData(p,0,0),l}}class S{width;height;canvas;ctx;constructor(t,e){this.width=t,this.height=e,this.canvas=c(t,e),this.ctx=this.canvas.getContext("2d")}draw(t,e,i,s){this.ctx.clearRect(0,0,this.width,this.height),this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle="rgba(0,0,0,.1)",this.ctx.strokeStyle="rgba(0,0,0,.15)",this.ctx.rect(t-i/2,e-s/2,i,s),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore(),this.ctx.beginPath()}}const v=[[null,null],[null,null]],x=t.ScrollDirection.ALL,y=t.BGPattern.GRID,T=t.WriteModel.WRITE,b="rgb(250,250,250)",C="green",O=["rgba(0,0,255,.5)","rgba(255,0,0,.5)","rgba(0,0,255,1)","rgba(0,0,255,.5)"],M="rgba(0,0,0,0.5)",k="rgb(0,0,0)",A="#333",G={scrollRange:v,scrollDirection:x,bgPattern:y,writeModel:T,enableBG:true,gridGap:100,gridPaperGap:100,quadrillePaperVerticalMargin:40,quadrillePaperGap:30,gridFillStyle:b,gridPaperStrokeStyle:C,quadrillePaperStrokeStyles:O,rule:true,ruleGap:10,ruleUnitLen:5,ruleStrokeStyle:M,voice:1,color:k,stack:true,cleanWidth:20,cleanHeight:20,moveCountTotal:20,writeLocked:false,dragLocked:false,showBorder:true,borderStyle:A,borderWidth:2,useShapeType:false};class D{container;width;height;worldOffsetX=0;worldOffsetY=0;scrolling=!1;d=1;maxD=2;pointsGroup=[];cleanState=!1;cleanX;cleanY;cleanPress=!1;stackObj;minX;minY;moveT=!1;debounceBindOnChange;prevPoints;toolShape;activateToolShape=!1;toolShapeCenterX;toolShapeCenterY;toolShapeAngle;background;ruleAuxiliary;border;writing;eraser;eraserHasContent=!1;toolShapeType=t.ShapeType.RULER;scrollRange;scrollDirection;bgPattern;writeModel;enableBG;gridGap;gridPaperGap;quadrillePaperVerticalMargin;quadrillePaperGap;gridFillStyle;gridPaperStrokeStyle;quadrillePaperStrokeStyles;rule;ruleGap;ruleUnitLen;ruleStrokeStyle;voice;color;cleanWidth;cleanHeight;stack;moveCountTotal;writeLocked;dragLocked;showBorder;borderStyle;borderWidth;useShapeType;containerOffset;onChange;constructor(t,i=G){this.container=t,this.scrollRange=i.scrollRange??v,this.scrollDirection=i.scrollDirection??x,this.bgPattern=i.bgPattern??y,this.writeModel=i.writeModel??T,this.enableBG=i.enableBG??true,this.gridGap=i.gridGap??100,this.gridPaperGap=i.gridPaperGap??100,this.quadrillePaperVerticalMargin=i.quadrillePaperVerticalMargin??40,this.quadrillePaperGap=i.quadrillePaperGap??30,this.gridFillStyle=i.gridFillStyle??b,this.gridPaperStrokeStyle=i.gridPaperStrokeStyle??C,this.quadrillePaperStrokeStyles=i.quadrillePaperStrokeStyles??O,this.rule=i.rule??true,this.ruleGap=i.ruleGap??10,this.ruleUnitLen=i.ruleUnitLen??5,this.ruleStrokeStyle=i.ruleStrokeStyle??M,this.voice=i.voice??1,this.color=i.color??k,this.stack=i.stack??true,this.cleanWidth=i.cleanWidth??20,this.cleanHeight=i.cleanHeight??20,this.moveCountTotal=i.moveCountTotal??20,this.writeLocked=i.writeLocked??false,this.dragLocked=i.dragLocked??false,this.showBorder=i.showBorder??true,this.borderStyle=i.borderStyle??A,this.borderWidth=i.borderWidth??2,this.useShapeType=i.useShapeType??false,this.containerOffset=i.containerOffset??(()=>{const t=document.scrollingElement,e=this.container.getBoundingClientRect();return{x:e.x+t.scrollLeft,y:e.y+t.scrollTop}}),this.onChange=i.onChange,this.debounceBindOnChange=function(t,e){let i;return function(...s){clearTimeout(i),i=setTimeout((()=>{t.apply(this,s)}),e)}}(this.triggerOnChange,500);const s=t.getBoundingClientRect();this.width=s.width,this.height=s.height,this.stack&&(this.stackObj=new e(this.width,this.height),this.stackObj.restoreState=t=>{const e=t[t.length-1],i=this.worldOffsetX,s=this.worldOffsetY,r=e.worldOffsetX-i,h=e.worldOffsetY-s;if(r||h){const e=r/this.moveCountTotal,i=h/this.moveCountTotal;this.writing.store=t,this.moveT=!0,this.doMove(e,i)}else this.worldOffsetX=e.worldOffsetX,this.worldOffsetY=e.worldOffsetY,this.writing.store=t,this.draw()}),this.background=new f(this.width,this.height,this.gridGap,this.gridFillStyle,this.gridPaperGap,this.gridPaperStrokeStyle,this.quadrillePaperVerticalMargin,this.quadrillePaperGap,this.quadrillePaperStrokeStyles),this.container.append(this.background.canvas),this.ruleAuxiliary=new w(this.width,this.height,this.ruleStrokeStyle,this.ruleGap,this.ruleUnitLen),this.container.append(this.ruleAuxiliary.canvas),this.border=new m(this.width,this.height,this.borderStyle,this.borderWidth),this.container.append(this.border.canvas),this.writing=new P(this.width,this.height),this.container.append(this.writing.canvas),this.toolShape=new u(this.width,this.height,this.voice,t,this.getPageCoords),this.container.append(this.toolShape.canvas),this.toolShapeCenterX=500,this.toolShapeCenterY=300,this.toolShapeAngle=10,this.eraser=new S(this.width,this.height),this.container.append(this.eraser.canvas),this.loadEvent(),this.draw()}setVoice(t=1){this.voice=t,this.d=t,this.maxD=2*t}showBG(){this.enableBG=!0,this.draw()}hideBG(){this.enableBG=!1,this.draw()}showRule(){this.rule=!0,this.draw()}hideRule(){this.rule=!1,this.draw()}showToolShape(){this.useShapeType=!0,this.draw()}hideToolShape(){this.useShapeType=!1,this.draw()}setToolShapeType(t){this.toolShapeType=t,this.draw()}adjustOffset(){const[[t,e],[i,s]]=this.scrollRange;"number"==typeof t&&(this.worldOffsetX=Math.max(t,this.worldOffsetX)),"number"==typeof e&&(this.worldOffsetX=Math.min(e,this.worldOffsetX)),"number"==typeof i&&(this.worldOffsetY=Math.max(i,this.worldOffsetY)),"number"==typeof s&&(this.worldOffsetY=Math.min(s,this.worldOffsetY)),this.worldOffsetX=Math.round(this.worldOffsetX),this.worldOffsetY=Math.round(this.worldOffsetY)}doMove(e,i,s=0){this.scrollDirection===t.ScrollDirection.ALL?(this.worldOffsetX+=e,this.worldOffsetY+=i):this.scrollDirection===t.ScrollDirection.X?this.worldOffsetX+=e:this.scrollDirection===t.ScrollDirection.Y&&(this.worldOffsetY+=i),this.adjustOffset(),this.draw(),self.requestAnimationFrame((()=>{this.moveT&&s<this.moveCountTotal?this.doMove(e,i,++s):this.moveT=!1}))}scrollBy(t=0,e=0){if(!this.dragLocked){const i=t/this.moveCountTotal,s=e/this.moveCountTotal;this.moveT=!0,this.doMove(i,s)}}clear(){this.worldOffsetX=0,this.worldOffsetY=0,this.writing.clear(),this.draw(),this.stackObj.saveState([...this.writing.store])}triggerOnChange(){window.requestIdleCallback((()=>{if(this.onChange){const t=this.exportAsCanvas();this.onChange(t)}}))}drawPureCanvas(t,e=!0){this.pointsGroup?.forEach((({corners:i,fillStyle:s})=>{i.forEach((([[i,r],[h,a],[o,n],[l,c]])=>{let d=i,g=r,p=h,u=a,f=o,w=n,m=l,P=c;e&&(d=i-this.minX,g=r-this.minY,p=h-this.minX,u=a-this.minY,f=o-this.minX,w=n-this.minY,m=l-this.minX,P=c-this.minY),t.save(),t.fillStyle=s,t.beginPath(),t.moveTo(d,g),t.lineTo(p,u),t.lineTo(m,P),t.lineTo(f,w),t.fill(),t.restore()}))}))}exportAsCanvas(){return this.writing.getWholeCanvas()}exportAsPaperCanvas(){const t=this.writing.getPaperCanvas(),e=document.createElement("canvas");e.width=t.width,e.height=t.height;const i=e.getContext("2d");return this.enableBG&&this.loadBackground(i),i.drawImage(t,0,0),e}undo(){this.stackObj.undo()}redo(){this.stackObj.redo()}clean(){this.cleanState=!0}unclean(){this.cleanState=!1}draw(){this.loadBackground(),this.loadRule(),this.writing.refresh(this.worldOffsetX,this.worldOffsetY),this.drawEraser(),this.drawToolShape(),this.debounceBindOnChange()}loadEvent(){let e,i=!1,s=!1,r=!1,h=!1,a=0,o=0,n=0,l=0,c=0,d=0,g=0,p=!1,u=!1,f=0,w=0,m=0,P=0,S=0,v=0;const x=t=>{i=!1,s=!1,u=!0,p=!0;let e=!1;if(this.useShapeType){e=this.toolShape.getNearestDistanceAndPoint(t.pageX,t.pageY,this.voice,this.color).conformingToDistance}!this.cleanState&&e?this.activateToolShape=!0:(!this.cleanState&&this.useShapeType&&this.toolShape.isPointInPath(t.pageX,t.pageY,"evenodd")&&(u=!1),this.activateToolShape=!1,P=t.pageX,S=t.pageY),v=performance.now(),this.cleanState&&(this.cleanX=P,this.cleanY=S,this.cleanPress=!0,this.drawEraser())},y=t=>{this.moveT=!1,this.scrolling=!1;const i=t.touches,s=this.getPageCoords(i);if(2===i.length){if(r=!0,u=!1,this.dragLocked)return;c=s.pageX,d=s.pageY,g=performance.now(),this.cleanState&&(this.cleanPress=!1,this.draw());let t=!1;this.useShapeType&&this.toolShape.isPointInPath(s.pageX,s.pageY,"nonzero")&&(t=!0),t?(h=!0,e={x:s.pageX,y:s.pageY}):h=!1}else 1===i.length&&(this.writeLocked||x(s))},T=t=>{if(t.preventDefault(),!this.writeLocked){const{pageX:e,pageY:i}=t,s=this.getPageCoords([{pageX:e,pageY:i}]);x(s)}},b=t=>{this.writing.singlePointsWriting(t)},C=(t,e,i,s)=>{p&&(this.prevPoints=null,p=!1);const r=this.pushPoints(t,e,i,s,m,v);r&&(this.prevPoints=r,this.doWriting(r),this.debounceBindOnChange())},O=t=>{if(i=!0,s=!0,f=P,w=S,m=v,P=t.pageX,S=t.pageY,v=performance.now(),this.cleanState)this.cleanX=P,this.cleanY=S,this.doClean(P,S),this.drawEraser();else if(this.useShapeType&&this.activateToolShape){const e=this.voice,{drawPoints:i}=this.toolShape.getNearestDistanceAndPoint(t.pageX,t.pageY,e,this.color);b(i)}else C(f,w,P,S)},M=t=>{if(u){const{pageX:e,pageY:i}=t,s=this.getPageCoords([{pageX:e,pageY:i}]);O(s)}},k=i=>{const s=i.touches;if(r){if(this.dragLocked)return;o=c,n=d,l=g;const r=this.getPageCoords(s);if(c=r.pageX,d=r.pageY,g=performance.now(),this.useShapeType&&h){const t=c-o,s=d-n;if(this.toolShapeCenterX+=t,this.toolShapeCenterY+=s,2===i.touches.length){const{angle:t}=function(t){const e=t.touches[0],i=t.touches[1],s=e.pageX,r=e.pageY,h=i.pageX,a=i.pageY,o=h-s,n=a-r;return{angle:Math.atan2(n,o)*(180/Math.PI),center:[(s+h)/2,(r+a)/2]}}(i);let s=t-a;s%=30,a=t;const[r,h]=function(t,e,i,s,r){const h=i*(Math.PI/180),a=s-t,o=r-e;return[Math.cos(h)*a-Math.sin(h)*o+t,Math.sin(h)*a+Math.cos(h)*o+e]}(e.x,e.y,s,this.toolShapeCenterX,this.toolShapeCenterY);this.toolShapeCenterX=r,this.toolShapeCenterY=h,this.toolShapeAngle+=s,this.draw()}}else{let e=0,i=0;this.scrollDirection===t.ScrollDirection.ALL?(e=c-o,i=d-n):this.scrollDirection===t.ScrollDirection.X?e=c-o:this.scrollDirection===t.ScrollDirection.Y&&(i=d-n),this.worldOffsetX-=e,this.worldOffsetY-=i,this.adjustOffset(),this.draw()}}else if(u){const t=this.getPageCoords(s);O(t)}},A=(t,e)=>{this.scrolling=!0;let i=0;const s=(t,e)=>{if(Math.abs(t)>.1||Math.abs(e)>.1){this.worldOffsetX-=t,this.worldOffsetY-=e,this.adjustOffset(),this.draw();const r=Math.max(99-.01*i++,50)/100;t*=r,e*=r,self.requestAnimationFrame((()=>{this.scrolling&&s(t,e)}))}else this.scrolling=!1};s(t,e)},G=e=>{if(r){if(this.dragLocked)return;const e=c-o,i=d-n,s=g-l;let r=0,a=0;this.scrollDirection===t.ScrollDirection.ALL?(r=e/s,a=i/s):this.scrollDirection===t.ScrollDirection.X?r=e/s:this.scrollDirection===t.ScrollDirection.Y&&(a=i/s),h||A(r,a)}else u&&(i||O(e),this.cleanState&&!this.eraserHasContent||(this.eraserHasContent=!1,this.writing.pushImageData(this.worldOffsetX,this.worldOffsetY),this.stack&&s&&this.stackObj.saveState(this.writing.store)));this.cleanState&&(this.cleanPress=!1,this.draw()),r=!1,u=!1,this.toolShape.prevPoint=null},D=t=>{const e=t.changedTouches,i=this.getPageCoords(e);G(i)},R=t=>{const{pageX:e,pageY:i}=t,s=this.getPageCoords([{pageX:e,pageY:i}]);G(s)},X=this.container;"ontouchstart"in self?(X.addEventListener("touchstart",y,{passive:!0}),X.addEventListener("touchmove",k,{passive:!0}),X.addEventListener("touchend",D,{passive:!0})):(X.addEventListener("mousedown",T),self.addEventListener("mousemove",M,{passive:!0}),self.addEventListener("mouseup",R,{passive:!0}))}getPageCoords=t=>{const{x:e,y:i}=this.containerOffset(),s=t.length;let r=0,h=0;for(let a=0;a<s;a++){const s=t[a];r+=s.pageX-e,h+=s.pageY-i}return r/=s,h/=s,{pageX:r,pageY:h}};drawEraser(){this.cleanState&&this.cleanPress&&this.eraser.draw(this.cleanX,this.cleanY,this.cleanWidth,this.cleanHeight),this.eraser.canvas.style.opacity=this.cleanState&&this.cleanPress?"1":"0"}doClean(t,e){this.writing.doClean(t-this.cleanWidth/2,e-this.cleanHeight/2,this.cleanWidth,this.cleanHeight,!0)&&(this.eraserHasContent=!0)}getCornerCoordinate(t,e,i,s,r,h){return[[r-e*s/Math.sqrt(t**2+e**2),h+t*s/Math.sqrt(t**2+e**2)],[r+e*s/Math.sqrt(t**2+e**2),h-t*s/Math.sqrt(t**2+e**2)]]}getCornersCoordinate(t,e,i,s,r){const h=i-t,a=s-e,o=h*t+a*e+r*Math.sqrt(h**2+a**2),[[n,l],[c,d]]=this.getCornerCoordinate(h,a,o,r,t,e),[[g,p],[u,f]]=this.getCornerCoordinate(h,a,o,r,i,s);return[[n,l],[c,d],[g,p],[u,f]]}pushPoints(e,i,s,r,h,a){const o=e,n=i,l=s,c=r,d=((c-n)**2+(l-o)**2)**.5,g=(a-h)/d*this.voice;if(!isNaN(g)){this.writeModel===t.WriteModel.WRITE?(g>1.2*this.d?this.d*=1.2:g<this.d/1.2?this.d/=1.2:this.d=g,this.d>this.maxD&&(this.d=this.maxD)):this.writeModel===t.WriteModel.DRAW&&(this.d=this.voice);const e=this.getCornersCoordinate(o,n,l,c,this.d);if(!e.flat().some((t=>isNaN(t))))return this.prevPoints&&(e[0]=this.prevPoints[2],e[1]=this.prevPoints[3]),e;if(!d){let e=this.voice;if(this.writeModel===t.WriteModel.WRITE){let t=(a-h)/250;t>2?t=2:t<1&&(t=1),e=this.voice*t}return[[o-e,n-e],[o-e,n+e],[o+e,n-e],[o+e,n+e]]}}}doWriting(t){this.writing.writing(t,this.color)}loadBackground(t=null){let e,i=0,s=0;if(t){const i=t.canvas,{width:s,height:r}=i;e=new f(s,r,this.gridGap,this.gridFillStyle,this.gridPaperGap,this.gridPaperStrokeStyle,this.quadrillePaperVerticalMargin,this.quadrillePaperGap,this.quadrillePaperStrokeStyles)}else{i=-l(this.worldOffsetX,2*this.gridGap),s=-l(this.worldOffsetY,2*this.gridGap),e=this.background}this.enableBG&&(e.draw(i,s,this.bgPattern),t&&t.drawImage(e.canvas,0,0)),e.canvas.style.opacity=this.enableBG?"1":"0"}loadRule(){this.rule&&this.ruleAuxiliary.draw(this.worldOffsetX,this.worldOffsetY),this.ruleAuxiliary.canvas.style.opacity=this.rule?"1":"0"}drawToolShape(){this.useShapeType&&this.toolShape.draw(this.toolShapeCenterX,this.toolShapeCenterY,this.toolShapeAngle,this.toolShapeType),this.toolShape.canvas.style.opacity=this.useShapeType?"1":"0"}}t.Board=D,t.default=D,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.min.js.map
